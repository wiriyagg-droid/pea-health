<!DOCTYPE html>

<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PEA Pattani Smart Health AI</title>
<style>body{font-family:sans-serif;}</style>
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<style>
:root {
  --pea-purple: #6B21A8; --pea-purple-dark: #3B0764; --pea-purple-mid: #7E22CE;
  --pea-gold: #B8860B; --pea-gold-light: #FFD700; --pea-gold-pale: #FFF8DC;
  --green: #00843D; --green-dark: #0A2818; --green-mid: #1B5E35;
  --green-light: #E8F5EE; --accent: #00C96A;
  --danger: #DC2626; --warning: #D97706; --warning-bg: #FFFBEB;
  --info: #1D4ED8; --info-bg: #EFF6FF;
  --text: #111827; --sub: #6B7280; --border: #E5E7EB;
  --bg: #F8FAFC; --card: #FFFFFF;
  --score-excellent: #059669; --score-good: #16A34A;
  --score-fair: #D97706; --score-poor: #DC2626;
}
* { margin:0; padding:0; box-sizing:border-box; }
body { font-family:'Sarabun',sans-serif; background:var(--bg); color:var(--text); min-height:100vh; }

/* ===== CONFIG BANNER ===== */
#config-banner {
background:linear-gradient(90deg,#FFF8DC,#FFFBEB);
border-bottom:2px solid var(‚Äìpea-gold);
padding:10px 20px; display:flex; align-items:center; gap:10px; flex-wrap:wrap;
}
#config-banner span { font-size:13px; font-weight:600; color:var(‚Äìpea-gold); }
#config-banner input {
padding:6px 11px; border:1px solid var(‚Äìpea-gold); border-radius:7px;
font-family:‚ÄòSarabun‚Äô,sans-serif; font-size:13px; flex:1; min-width:200px; max-width:300px;
}
.btn-cfg { padding:6px 16px; background:var(‚Äìpea-purple); color:white; border:none; border-radius:7px; cursor:pointer; font-family:‚ÄòSarabun‚Äô,sans-serif; font-size:13px; font-weight:600; white-space:nowrap; }

/* ===== SCREENS ===== */
.screen { display:none; }
.screen.active { display:flex; }

/* ===== PEA LOGO SVG ===== */
.pea-logo-svg { width:44px; height:44px; flex-shrink:0; }

/* ===== LOGIN ===== */
#login-screen {
min-height:100vh; flex-direction:column;
background:linear-gradient(160deg, var(‚Äìpea-purple-dark) 0%, var(‚Äìpea-purple) 50%, #4C1D95 100%);
justify-content:center; align-items:center; position:relative; overflow:hidden;
}
#login-screen::before {
content:‚Äô‚Äô; position:absolute; width:600px; height:600px;
background:radial-gradient(circle, rgba(255,215,0,.08) 0%, transparent 65%);
top:-150px; right:-150px; border-radius:50%;
}
#login-screen::after {
content:‚Äô‚Äô; position:absolute; width:400px; height:400px;
background:radial-gradient(circle, rgba(0,201,106,.06) 0%, transparent 65%);
bottom:-100px; left:-100px; border-radius:50%;
}
.login-card {
background:rgba(255,255,255,.07); backdrop-filter:blur(24px);
border:1px solid rgba(255,255,255,.12); border-radius:24px;
padding:44px 40px; width:420px; position:relative; z-index:1;
animation:fadeUp .6s ease;
}
@keyframes fadeUp { from{opacity:0;transform:translateY(28px)} to{opacity:1;transform:translateY(0)} }
.login-header { display:flex; align-items:center; gap:14px; margin-bottom:8px; }
.login-title h1 { font-family:‚ÄòPrompt‚Äô,sans-serif; font-size:18px; font-weight:700; color:white; line-height:1.3; }
.login-title p { font-size:12px; color:rgba(255,255,255,.5); margin-top:2px; }
.login-subtitle { color:rgba(255,255,255,.4); font-size:12px; text-align:center; margin-bottom:28px; padding:8px 0; border-top:1px solid rgba(255,255,255,.1); border-bottom:1px solid rgba(255,255,255,.1); }
.tab-row { display:flex; gap:8px; margin-bottom:22px; }
.tab { flex:1; padding:10px; border-radius:10px; border:1px solid rgba(255,255,255,.15); background:rgba(255,255,255,.05); color:rgba(255,255,255,.55); font-family:‚ÄòSarabun‚Äô,sans-serif; font-size:13px; cursor:pointer; transition:.3s; text-align:center; }
.tab.active { background:var(‚Äìpea-purple-mid); border-color:var(‚Äìpea-gold); color:white; font-weight:600; }
.lbl { color:rgba(255,255,255,.65); font-size:13px; font-weight:500; margin-bottom:7px; display:block; }
.linput { width:100%; background:rgba(255,255,255,.09); border:1px solid rgba(255,255,255,.18); border-radius:11px; padding:13px 15px; color:white; font-family:‚ÄòSarabun‚Äô,sans-serif; font-size:15px; margin-bottom:16px; transition:.3s; }
.linput:focus { outline:none; border-color:var(‚Äìpea-gold-light); background:rgba(255,255,255,.14); }
.linput::placeholder { color:rgba(255,255,255,.35); }
.btn-login { width:100%; padding:14px; background:linear-gradient(135deg,var(‚Äìpea-gold),#B8860B); border:none; border-radius:11px; color:var(‚Äìpea-purple-dark); font-family:‚ÄòPrompt‚Äô,sans-serif; font-size:15px; font-weight:700; cursor:pointer; box-shadow:0 4px 20px rgba(184,134,11,.4); transition:.3s; }
.btn-login:hover { transform:translateY(-2px); box-shadow:0 6px 25px rgba(184,134,11,.5); }
.err-msg { color:#FCA5A5; font-size:13px; text-align:center; margin-top:8px; min-height:18px; }
.hint { color:rgba(255,255,255,.3); font-size:11px; text-align:center; margin-top:12px; }

/* ===== MAIN LAYOUT ===== */
#main-screen { flex-direction:row; min-height:100vh; }
.sidebar {
width:248px; min-height:100vh; padding:20px 0;
display:flex; flex-direction:column;
position:fixed; left:0; top:0; bottom:0; z-index:100; overflow-y:auto;
background:linear-gradient(180deg, var(‚Äìpea-purple-dark) 0%, #1E1B4B 100%);
}
.sb-logo { display:flex; align-items:center; gap:11px; padding:0 18px; margin-bottom:24px; }
.sb-logo .pea-logo-svg { width:38px; height:38px; }
.sb-brand { color:white; }
.sb-brand-main { font-family:‚ÄòPrompt‚Äô,sans-serif; font-size:13px; font-weight:700; line-height:1.2; color:var(‚Äìpea-gold-light); }
.sb-brand-sub { font-size:10px; color:rgba(255,255,255,.4); margin-top:1px; }
.nav-sec { padding:0 10px; margin-bottom:4px; }
.nav-lbl { color:rgba(255,255,255,.25); font-size:9px; font-weight:700; letter-spacing:1.8px; text-transform:uppercase; padding:0 8px; margin-bottom:4px; }
.nv { display:flex; align-items:center; gap:9px; padding:9px 11px; border-radius:10px; color:rgba(255,255,255,.5); cursor:pointer; transition:.2s; font-size:13px; margin-bottom:1px; }
.nv:hover { background:rgba(255,255,255,.07); color:rgba(255,255,255,.85); }
.nv.active { background:linear-gradient(90deg,var(‚Äìpea-purple-mid),rgba(107,33,168,.6)); color:white; font-weight:600; border-left:3px solid var(‚Äìpea-gold-light); }
.nv .ic { font-size:14px; width:18px; text-align:center; }
.sb-div { border:none; border-top:1px solid rgba(255,255,255,.07); margin:8px 16px; }
.sb-user { margin-top:auto; padding:12px 16px; border-top:1px solid rgba(255,255,255,.07); }
.user-row { display:flex; align-items:center; gap:9px; }
.avatar { width:34px; height:34px; border-radius:50%; background:linear-gradient(135deg,var(‚Äìpea-gold-light),var(‚Äìpea-gold)); display:flex; align-items:center; justify-content:center; font-weight:700; color:var(‚Äìpea-purple-dark); font-size:13px; flex-shrink:0; }
.uname { color:white; font-size:12px; font-weight:600; }
.uid { color:rgba(255,255,255,.35); font-size:10px; }
.btn-out { margin-top:8px; width:100%; padding:7px; background:rgba(255,255,255,.04); border:1px solid rgba(255,255,255,.08); border-radius:7px; color:rgba(255,255,255,.4); font-family:‚ÄòSarabun‚Äô,sans-serif; font-size:12px; cursor:pointer; transition:.2s; }
.btn-out:hover { background:rgba(220,38,38,.15); color:#FCA5A5; border-color:rgba(220,38,38,.3); }

/* ===== CONTENT ===== */
.content { margin-left:248px; flex:1; background:var(‚Äìbg); }
.topbar { background:white; border-bottom:1px solid var(‚Äìborder); padding:0 26px; height:58px; display:flex; align-items:center; justify-content:space-between; position:sticky; top:0; z-index:50; }
.topbar-left { display:flex; align-items:center; gap:10px; }
.topbar-title { font-family:‚ÄòPrompt‚Äô,sans-serif; font-size:15px; font-weight:600; color:var(‚Äìpea-purple-dark); }
.module-tag { padding:3px 11px; border-radius:20px; font-size:11px; font-weight:600; }
.tag-annual { background:#EDE9FE; color:#5B21B6; }
.tag-risk { background:#FEF3C7; color:#92400E; }
.tag-admin { background:#DBEAFE; color:#1E40AF; }

.pad { padding:24px; }
.page { display:none; }
.page.active { display:block; animation:fadeIn .3s ease; }
@keyframes fadeIn { from{opacity:0;transform:translateY(6px)} to{opacity:1;transform:translateY(0)} }

/* ===== CARDS ===== */
.card { background:var(‚Äìcard); border-radius:14px; padding:20px; border:1px solid var(‚Äìborder); box-shadow:0 1px 3px rgba(0,0,0,.05); }
.card-title { font-family:‚ÄòPrompt‚Äô,sans-serif; font-size:13px; font-weight:600; color:var(‚Äìsub); margin-bottom:14px; display:flex; align-items:center; gap:7px; }
.grid-4 { display:grid; grid-template-columns:repeat(4,1fr); gap:14px; margin-bottom:20px; }
.grid-3 { display:grid; grid-template-columns:repeat(3,1fr); gap:14px; margin-bottom:20px; }
.grid-2 { display:grid; grid-template-columns:1fr 1fr; gap:18px; margin-bottom:20px; }
.grid-21 { display:grid; grid-template-columns:3fr 2fr; gap:18px; margin-bottom:20px; }
.grid-form { display:grid; grid-template-columns:1fr 1fr; gap:12px; }
.grid-form-3 { display:grid; grid-template-columns:1fr 1fr 1fr; gap:12px; }

.stat-card { background:var(‚Äìcard); border-radius:13px; padding:16px; border:1px solid var(‚Äìborder); transition:transform .2s; }
.stat-card:hover { transform:translateY(-2px); }
.stat-ico { font-size:20px; margin-bottom:7px; }
.stat-lbl { font-size:11px; color:var(‚Äìsub); font-weight:500; margin-bottom:5px; }
.stat-val { font-family:‚ÄòPrompt‚Äô,sans-serif; font-size:24px; font-weight:700; color:var(‚Äìtext); }
.stat-unit { font-size:12px; font-weight:400; color:var(‚Äìsub); margin-left:2px; }
.badge { display:inline-block; padding:2px 9px; border-radius:20px; font-size:10px; font-weight:700; margin-top:5px; }
.b-ok { background:#DCFCE7; color:#15803D; }
.b-warn { background:#FEF3C7; color:#92400E; }
.b-danger { background:#FEE2E2; color:#B91C1C; }
.b-info { background:#DBEAFE; color:#1E40AF; }
.b-gray { background:#F3F4F6; color:#6B7280; }
.b-purple { background:#EDE9FE; color:#5B21B6; }

/* ===== SCORE SYSTEM ===== */
.score-explain { background:linear-gradient(135deg,#F5F3FF,#EDE9FE); border:1px solid #DDD6FE; border-radius:14px; padding:20px; margin-bottom:20px; }
.score-explain h3 { font-family:‚ÄòPrompt‚Äô,sans-serif; font-size:14px; font-weight:700; color:var(‚Äìpea-purple-dark); margin-bottom:12px; }
.score-row { display:flex; align-items:center; gap:10px; margin-bottom:8px; }
.score-dot { width:10px; height:10px; border-radius:50%; flex-shrink:0; }
.score-desc { font-size:13px; color:var(‚Äìsub); }
.score-weight-grid { display:grid; grid-template-columns:repeat(3,1fr); gap:8px; margin-top:12px; }
.score-weight-item { background:white; border-radius:8px; padding:10px; border:1px solid #DDD6FE; text-align:center; }
.score-weight-val { font-family:‚ÄòPrompt‚Äô,sans-serif; font-size:16px; font-weight:700; color:var(‚Äìpea-purple-dark); }
.score-weight-lbl { font-size:11px; color:var(‚Äìsub); margin-top:2px; }

/* ===== RING ===== */
.ring-wrap { display:flex; flex-direction:column; align-items:center; padding:12px 0; }
.ring-container { position:relative; width:130px; height:130px; }
.ring-svg { width:130px; height:130px; transform:rotate(-90deg); }
.ring-bg-c { fill:none; stroke:#E5E7EB; stroke-width:13; }
.ring-fill-c { fill:none; stroke-width:13; stroke-linecap:round; stroke-dasharray:339; transition:stroke-dashoffset 1.2s ease; }
.ring-txt { position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); text-align:center; }
.ring-num { font-family:‚ÄòPrompt‚Äô,sans-serif; font-size:28px; font-weight:800; }
.ring-sub-txt { font-size:10px; color:var(‚Äìsub); }

/* ===== CHART AREA ===== */
.chart-wrap { position:relative; height:220px; }
.chart-wrap-sm { position:relative; height:160px; }

/* ===== TREND INDICATOR ===== */
.trend-up { color:var(‚Äìdanger); }
.trend-down { color:var(‚Äìscore-excellent); }
.trend-stable { color:var(‚Äìsub); }

/* ===== TABLE ===== */
.tbl { width:100%; border-collapse:collapse; }
.tbl th { text-align:left; padding:8px 12px; background:var(‚Äìbg); color:var(‚Äìsub); font-size:11px; font-weight:700; text-transform:uppercase; letter-spacing:.4px; border-bottom:1px solid var(‚Äìborder); }
.tbl td { padding:10px 12px; border-bottom:1px solid var(‚Äìborder); font-size:13px; }
.tbl tr:last-child td { border-bottom:none; }
.tbl tr:hover td { background:var(‚Äìbg); }

/* ===== AI BOX ===== */
.ai-box { background:linear-gradient(135deg,var(‚Äìpea-purple-dark),var(‚Äìpea-purple)); border-radius:14px; padding:20px; color:white; margin-bottom:20px; position:relative; overflow:hidden; }
.ai-box::after { content:‚Äòü§ñ‚Äô; position:absolute; right:16px; top:50%; transform:translateY(-50%); font-size:60px; opacity:.07; }
.ai-dot { width:7px; height:7px; border-radius:50%; background:var(‚Äìpea-gold-light); animation:pulse 2s infinite; display:inline-block; }
@keyframes pulse { 0%,100%{opacity:1;transform:scale(1)} 50%{opacity:.4;transform:scale(1.4)} }
.ai-head { display:flex; align-items:center; gap:9px; margin-bottom:12px; }
.ai-title { font-family:‚ÄòPrompt‚Äô,sans-serif; font-size:13px; font-weight:600; }
.ai-text { font-size:13px; line-height:1.9; color:rgba(255,255,255,.88); }
.ai-tags { display:flex; flex-wrap:wrap; gap:6px; margin-top:12px; }
.at-warn { padding:3px 10px; border-radius:20px; font-size:11px; font-weight:600; background:rgba(217,119,6,.2); color:#FCD34D; border:1px solid rgba(217,119,6,.3); }
.at-good { padding:3px 10px; border-radius:20px; font-size:11px; font-weight:600; background:rgba(0,201,106,.2); color:#6EE7B7; border:1px solid rgba(0,201,106,.3); }
.at-info { padding:3px 10px; border-radius:20px; font-size:11px; font-weight:600; background:rgba(29,78,216,.2); color:#93C5FD; border:1px solid rgba(29,78,216,.3); }

/* ===== FORM ===== */
.sec-title { font-family:‚ÄòPrompt‚Äô,sans-serif; font-size:13px; font-weight:700; color:var(‚Äìpea-purple-dark); margin:18px 0 10px; padding-bottom:7px; border-bottom:2px solid #EDE9FE; display:flex; align-items:center; gap:8px; }
.fg { }
.fl { display:block; font-size:12px; font-weight:600; color:var(‚Äìsub); margin-bottom:4px; }
.fi { width:100%; padding:9px 12px; border:1px solid var(‚Äìborder); border-radius:8px; font-family:‚ÄòSarabun‚Äô,sans-serif; font-size:13px; color:var(‚Äìtext); background:white; transition:.2s; }
.fi:focus { outline:none; border-color:var(‚Äìpea-purple-mid); box-shadow:0 0 0 3px rgba(107,33,168,.1); }
.fi:disabled { background:#F9FAFB; color:var(‚Äìsub); }
.not-tested-wrap { display:flex; align-items:center; gap:6px; margin-top:5px; }
.not-tested-wrap input[type=checkbox] { width:14px; height:14px; accent-color:var(‚Äìpea-purple); }
.not-tested-wrap label { font-size:11px; color:var(‚Äìsub); cursor:pointer; }
.btn-row { display:flex; gap:10px; margin-top:20px; }
.btn-primary { padding:10px 22px; border-radius:8px; background:var(‚Äìpea-purple); border:none; color:white; font-family:‚ÄòPrompt‚Äô,sans-serif; font-size:13px; font-weight:600; cursor:pointer; transition:.2s; }
.btn-primary:hover { background:var(‚Äìpea-purple-mid); }
.btn-primary:disabled { background:#9CA3AF; cursor:not-allowed; }
.btn-sec { padding:10px 16px; border-radius:8px; background:white; border:1px solid var(‚Äìborder); color:var(‚Äìsub); font-family:‚ÄòSarabun‚Äô,sans-serif; font-size:13px; cursor:pointer; transition:.2s; }
.btn-sec:hover { border-color:var(‚Äìpea-purple); color:var(‚Äìpea-purple); }
.btn-gold { padding:10px 22px; border-radius:8px; background:linear-gradient(135deg,var(‚Äìpea-gold-light),var(‚Äìpea-gold)); border:none; color:var(‚Äìpea-purple-dark); font-family:‚ÄòPrompt‚Äô,sans-serif; font-size:13px; font-weight:700; cursor:pointer; transition:.2s; }
.btn-gold:hover { transform:translateY(-1px); }

/* ===== NOTIFICATION ===== */
.notif { position:fixed; top:68px; right:20px; padding:12px 18px; border-radius:10px; font-size:13px; z-index:999; box-shadow:0 8px 28px rgba(0,0,0,.15); display:none; animation:slideIn .4s ease; max-width:300px; }
.notif-success { background:var(‚Äìpea-purple-dark); color:white; border-left:4px solid var(‚Äìpea-gold-light); }
.notif-error { background:#DC2626; color:white; }
@keyframes slideIn { from{opacity:0;transform:translateX(18px)} to{opacity:1;transform:translateX(0)} }

/* ===== MISC ===== */
.loading { text-align:center; padding:40px; color:var(‚Äìsub); font-size:14px; }
.spinner { display:inline-block; width:18px; height:18px; border:3px solid var(‚Äìborder); border-top-color:var(‚Äìpea-purple); border-radius:50%; animation:spin 1s linear infinite; margin-right:8px; vertical-align:middle; }
@keyframes spin { to{transform:rotate(360deg)} }
.empty { text-align:center; padding:48px 24px; color:var(‚Äìsub); }
.empty-ico { font-size:44px; margin-bottom:10px; }
.alert-warn { padding:12px 15px; border-radius:9px; font-size:13px; margin-bottom:18px; background:#FFFBEB; border:1px solid #FCD34D; color:#92400E; }
.alert-info { padding:12px 15px; border-radius:9px; font-size:13px; margin-bottom:18px; background:#EFF6FF; border:1px solid #BFDBFE; color:#1E40AF; }
.ytabs { display:flex; gap:5px; }
.ytab { padding:4px 12px; border-radius:20px; border:1px solid var(‚Äìborder); background:white; color:var(‚Äìsub); font-size:12px; cursor:pointer; transition:.2s; }
.ytab.active { background:var(‚Äìpea-purple); border-color:var(‚Äìpea-purple); color:white; font-weight:600; }

/* ===== OVERVIEW ===== */
.ov-card { background:var(‚Äìcard); border-radius:13px; padding:16px; border:1px solid var(‚Äìborder); text-align:center; }
.ov-num { font-family:‚ÄòPrompt‚Äô,sans-serif; font-size:32px; font-weight:800; }
.ov-lbl { font-size:12px; color:var(‚Äìsub); margin-top:3px; }
.dept-row { display:flex; align-items:center; gap:9px; margin-bottom:10px; }
.dept-nm { font-size:12px; color:var(‚Äìsub); width:125px; flex-shrink:0; }
.dept-track { flex:1; height:8px; background:var(‚Äìborder); border-radius:4px; overflow:hidden; }
.dept-fill { height:100%; border-radius:4px; }
.dept-pct { font-size:12px; font-weight:700; width:35px; text-align:right; }
.risk-row { display:flex; justify-content:space-between; align-items:center; padding:11px 0; border-bottom:1px solid var(‚Äìborder); }
.risk-row:last-child { border-bottom:none; }
.risk-nm { font-size:13px; font-weight:500; }
.risk-sb { font-size:11px; color:var(‚Äìsub); margin-top:1px; }
.risk-num { font-family:‚ÄòPrompt‚Äô,sans-serif; font-size:20px; font-weight:800; }

/* ===== MODAL ===== */
.modal-bg { position:fixed; inset:0; background:rgba(0,0,0,.5); z-index:500; display:flex; align-items:center; justify-content:center; animation:fadeIn .2s ease; }
.modal { background:white; border-radius:18px; padding:28px; width:520px; max-width:95vw; max-height:88vh; overflow-y:auto; box-shadow:0 25px 60px rgba(0,0,0,.25); position:relative; }
.modal-title { font-family:‚ÄòPrompt‚Äô,sans-serif; font-size:16px; font-weight:700; color:var(‚Äìpea-purple-dark); margin-bottom:18px; display:flex; align-items:center; gap:9px; }
.modal-close { position:absolute; top:18px; right:18px; background:var(‚Äìbg); border:none; border-radius:50%; width:30px; height:30px; cursor:pointer; font-size:16px; display:flex; align-items:center; justify-content:center; color:var(‚Äìsub); }
.modal-close:hover { background:var(‚Äìborder); }

/* ===== ADMIN TABS ===== */
.admin-tabs { display:flex; gap:6px; margin-bottom:20px; flex-wrap:wrap; }
.admin-tab { padding:8px 16px; border-radius:22px; border:1px solid var(‚Äìborder); background:white; color:var(‚Äìsub); font-family:‚ÄòSarabun‚Äô,sans-serif; font-size:13px; cursor:pointer; transition:.2s; }
.admin-tab.active { background:var(‚Äìpea-purple); border-color:var(‚Äìpea-purple); color:white; font-weight:600; }

/* ===== EMPLOYEE TABLE ===== */
.emp-table { width:100%; border-collapse:collapse; font-size:13px; }
.emp-table th { background:var(‚Äìbg); padding:9px 12px; text-align:left; font-size:11px; font-weight:700; color:var(‚Äìsub); text-transform:uppercase; letter-spacing:.4px; border-bottom:1px solid var(‚Äìborder); white-space:nowrap; }
.emp-table td { padding:10px 12px; border-bottom:1px solid var(‚Äìborder); vertical-align:middle; }
.emp-table tr:hover td { background:#FAFAFA; }
.btn-xs { padding:4px 10px; border-radius:6px; font-size:11px; font-weight:600; cursor:pointer; border:none; font-family:‚ÄòSarabun‚Äô,sans-serif; transition:.2s; }
.btn-edit { background:#EDE9FE; color:#5B21B6; }
.btn-edit:hover { background:#DDD6FE; }
.btn-reset { background:#FEF3C7; color:#92400E; }
.btn-reset:hover { background:#FDE68A; }
.btn-del { background:#FEE2E2; color:#B91C1C; }
.btn-del:hover { background:#FECACA; }

/* ===== RISK DASHBOARD ===== */
.risk-stat-grid { display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-bottom:18px; }
.risk-stat-card { background:var(‚Äìcard); border:1px solid var(‚Äìborder); border-radius:12px; padding:14px; }
.risk-stat-ico { font-size:22px; margin-bottom:6px; }
.risk-stat-lbl { font-size:11px; color:var(‚Äìsub); font-weight:500; }
.risk-stat-val { font-family:‚ÄòPrompt‚Äô,sans-serif; font-size:20px; font-weight:700; margin-top:3px; }
</style>

</head>
<body>

<!-- CONFIG BANNER -->

<div id="config-banner">
  <span>‚öôÔ∏è ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Supabase:</span>
  <input type="text" id="sb-url" placeholder="https://xxxx.supabase.co">
  <input type="text" id="sb-key" placeholder="anon public key">
  <input type="text" id="ai-key" placeholder="Anthropic API Key (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö AI)">
  <button class="btn-cfg" onclick="saveConfig()">‚úì ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
</div>

<div id="app">
<!-- ===== LOGIN ===== -->
<div id="login-screen" class="screen active">
  <div class="login-card">
    <div class="login-header">
      <!-- Lightning Bolt Logo -->
      <svg style="width:54px;height:54px;flex-shrink:0;" viewBox="0 0 100 100">
        <defs>
          <radialGradient id="glow-login" cx="50%" cy="40%" r="55%">
            <stop offset="0%" stop-color="#FFFDE7"/>
            <stop offset="60%" stop-color="#FFD700"/>
            <stop offset="100%" stop-color="#F59E0B"/>
          </radialGradient>
          <filter id="blur-login"><feGaussianBlur stdDeviation="3" result="blur"/><feComposite in="SourceGraphic" in2="blur" operator="over"/></filter>
        </defs>
        <!-- Glow circle -->
        <circle cx="50" cy="50" r="44" fill="rgba(255,215,0,0.12)"/>
        <circle cx="50" cy="50" r="38" fill="rgba(255,215,0,0.08)"/>
        <!-- Big bold lightning bolt -->
        <polygon points="58,8 28,52 48,52 42,92 72,48 52,48" fill="url(#glow-login)" filter="url(#blur-login)" opacity="0.35"/>
        <polygon points="58,8 28,52 48,52 42,92 72,48 52,48" fill="url(#glow-login)"/>
        <!-- Highlight streak -->
        <polygon points="56,14 40,46 50,46" fill="rgba(255,255,255,0.5)"/>
      </svg>
      <div class="login-title">
        <h1>PEA Pattani<br>Smart Health AI</h1>
        <p>‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡∏≠‡∏±‡∏à‡∏â‡∏£‡∏¥‡∏¢‡∏∞ ‡∏Å‡∏≤‡∏£‡πÑ‡∏ü‡∏ü‡πâ‡∏≤‡∏™‡πà‡∏ß‡∏ô‡∏†‡∏π‡∏°‡∏¥‡∏†‡∏≤‡∏Ñ</p>
      </div>
    </div>
    <div class="login-subtitle">‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡∏õ‡∏±‡∏ï‡∏ï‡∏≤‡∏ô‡∏µ ¬∑ Provincial Electricity Authority</div>
    <div class="tab-row">
      <div class="tab active" id="tab-annual" onclick="setTab('annual')">üè• ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏õ‡∏µ</div>
      <div class="tab" id="tab-risk" onclick="setTab('risk')">‚ö†Ô∏è ‡∏ï‡∏£‡∏ß‡∏à‡∏õ‡∏±‡∏à‡∏à‡∏±‡∏¢‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á</div>
    </div>
    <label class="lbl">‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</label>
    <input class="linput" type="text" id="l-empid" placeholder="‡πÄ‡∏ä‡πà‡∏ô EMP001" autocomplete="username">
    <label class="lbl">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</label>
    <input class="linput" type="password" id="l-pass" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" onkeydown="if(event.key==='Enter')doLogin()">
    <button class="btn-login" onclick="doLogin()" id="btn-login-submit">üîê ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
    <div class="err-msg" id="login-err"></div>
    <p class="hint">Demo: EMP001 / 1234 &nbsp;|&nbsp; Admin: ADMIN01 / 1234</p>
  </div>
</div>

<!-- ===== MAIN APP ===== -->

<div id="main-screen" class="screen">
  <nav class="sidebar">
    <div class="sb-logo">
      <!-- Lightning Bolt -->
      <svg style="width:36px;height:36px;flex-shrink:0;" viewBox="0 0 100 100">
        <defs>
          <radialGradient id="glow-sb" cx="50%" cy="40%" r="55%">
            <stop offset="0%" stop-color="#FFFDE7"/>
            <stop offset="60%" stop-color="#FFD700"/>
            <stop offset="100%" stop-color="#F59E0B"/>
          </radialGradient>
          <filter id="blur-sb"><feGaussianBlur stdDeviation="4" result="blur"/><feComposite in="SourceGraphic" in2="blur" operator="over"/></filter>
        </defs>
        <circle cx="50" cy="50" r="44" fill="rgba(255,215,0,0.1)"/>
        <polygon points="58,8 28,52 48,52 42,92 72,48 52,48" fill="url(#glow-sb)" filter="url(#blur-sb)" opacity="0.3"/>
        <polygon points="58,8 28,52 48,52 42,92 72,48 52,48" fill="url(#glow-sb)"/>
        <polygon points="56,14 40,46 50,46" fill="rgba(255,255,255,0.45)"/>
      </svg>
      <div class="sb-brand">
        <div class="sb-brand-main">PEA Smart Health AI</div>
        <div class="sb-brand-sub">Pattani ¬∑ ‡∏õ‡∏±‡∏ï‡∏ï‡∏≤‡∏ô‡∏µ</div>
      </div>
    </div>

```
<div class="nav-sec" id="sidebar-annual-nav">
  <div class="nav-lbl">‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏õ‡∏µ</div>
  <div class="nv active" id="nv-dashboard" onclick="goto('dashboard')"><span class="ic">üè†</span>‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</div>
  <div class="nv" id="nv-results" onclick="goto('results')"><span class="ic">üìã</span>‡∏ú‡∏•‡∏ï‡∏£‡∏ß‡∏à‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</div>
  <div class="nv" id="nv-ai" onclick="goto('ai')"><span class="ic">ü§ñ</span>AI ‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û</div>
  <div class="nv" id="nv-enter-annual" onclick="goto('enter-annual')"><span class="ic">‚úèÔ∏è</span>‡∏•‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏•‡∏ï‡∏£‡∏ß‡∏à</div>
  <hr class="sb-div" style="margin:8px 0;">
  <div class="nav-lbl">‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏≠‡∏á‡∏Ñ‡πå‡∏Å‡∏£</div>
  <div class="nv" id="nv-org-health" onclick="goto('org-health')"><span class="ic">üìä</span>‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡∏≠‡∏á‡∏Ñ‡πå‡∏Å‡∏£</div>
</div>

<div class="nav-sec" id="sidebar-risk-nav" style="display:none">
  <div class="nav-lbl">‡∏ï‡∏£‡∏ß‡∏à‡∏ï‡∏≤‡∏°‡∏õ‡∏±‡∏à‡∏à‡∏±‡∏¢‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á</div>
  <div class="nv" id="nv-risk-dash" onclick="goto('risk-dash')"><span class="ic">üè†</span>‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</div>
  <div class="nv" id="nv-my-risk" onclick="goto('my-risk')"><span class="ic">üìã</span>‡∏ú‡∏•‡∏ï‡∏£‡∏ß‡∏à‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</div>
  <div class="nv" id="nv-enter-risk" onclick="goto('enter-risk')"><span class="ic">‚úèÔ∏è</span>‡∏•‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏•‡∏ï‡∏£‡∏ß‡∏à</div>
  <div class="nv" id="nv-overview" onclick="goto('overview')" style="display:none"><span class="ic">üìà</span>‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏≠‡∏á‡∏Ñ‡πå‡∏Å‡∏£</div>
  <div class="nv" id="nv-report" onclick="goto('report')" style="display:none"><span class="ic">üìÑ</span>‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ï‡∏≤‡∏°‡∏Å‡∏é‡∏´‡∏°‡∏≤‡∏¢</div>
  <div class="nv" id="nv-admin" onclick="goto('admin')" style="display:none"><span class="ic">üëë</span>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡∏ö‡∏ö (Admin)</div>
</div>

<div class="sb-user">
  <div class="user-row">
    <div class="avatar" id="sb-avatar">‡∏Å</div>
    <div><div class="uname" id="sb-name">‚Äî</div><div class="uid" id="sb-id">‚Äî</div></div>
  </div>
  <button class="btn-out" onclick="doLogout()">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
</div>
```

  </nav>

  <div class="content">

```
<!-- PAGE: DASHBOARD -->
<div id="page-dashboard" class="page active">
  <div class="topbar">
    <div class="topbar-left">
      <span class="topbar-title">üè† ‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</span>
      <span class="module-tag tag-annual">‚óè ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏õ‡∏µ</span>
    </div>
    <div class="ytabs" id="dash-ytabs"></div>
  </div>
  <div class="pad" id="dash-content">
    <div class="loading"><span class="spinner"></span>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</div>
  </div>
</div>

<!-- PAGE: RESULTS -->
<div id="page-results" class="page">
  <div class="topbar">
    <div class="topbar-left">
      <span class="topbar-title">üìã ‡∏ú‡∏•‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏õ‡∏µ‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</span>
      <span class="module-tag tag-annual">‚óè ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏õ‡∏µ</span>
    </div>
    <div class="ytabs" id="res-ytabs"></div>
  </div>
  <div class="pad"><div id="res-content"><div class="loading"><span class="spinner"></span>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div></div></div>
</div>

<!-- PAGE: AI -->
<div id="page-ai" class="page">
  <div class="topbar">
    <div class="topbar-left">
      <span class="topbar-title">ü§ñ AI ‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û</span>
      <span class="module-tag tag-annual">‚óè ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏õ‡∏µ</span>
    </div>
  </div>
  <div class="pad"><div id="ai-content"><div class="loading"><span class="spinner"></span>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div></div></div>
</div>

<!-- PAGE: ENTER ANNUAL -->
<div id="page-enter-annual" class="page">
  <div class="topbar">
    <div class="topbar-left">
      <span class="topbar-title">‚úèÔ∏è ‡∏•‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏•‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏õ‡∏µ</span>
      <span class="module-tag tag-annual">‚óè ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏õ‡∏µ</span>
    </div>
  </div>
  <div class="pad">
    <div class="alert-info">üí° ‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏°‡∏µ‡πÉ‡∏ô‡∏ú‡∏•‡∏ï‡∏£‡∏ß‡∏à ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏£‡∏ß‡∏à‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÑ‡∏´‡∏ô ‡πÉ‡∏´‡πâ‡∏ï‡∏¥‡πä‡∏Å "‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏£‡∏ß‡∏à" ‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏ä‡πà‡∏≠‡∏á</div>
    <div class="card">
      <div class="sec-title">üìÖ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ</div>
      <div class="grid-form">
        <div class="fg"><label class="fl">‡∏õ‡∏µ ‡∏û.‡∏®.</label><input class="fi" type="number" id="f-year" value="2568"></div>
        <div class="fg"><label class="fl">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏ß‡∏à</label><input class="fi" type="date" id="f-date"></div>
        <div class="fg"><label class="fl">‡∏™‡∏ñ‡∏≤‡∏ô‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•</label><input class="fi" type="text" id="f-hospital" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡∏õ‡∏±‡∏ï‡∏ï‡∏≤‡∏ô‡∏µ"></div>
      </div>

      <div class="sec-title">‚öñÔ∏è ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡πà‡∏≤‡∏á‡∏Å‡∏≤‡∏¢ & ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏±‡∏ô</div>
      <div class="grid-form-3">
        <div class="fg"><label class="fl">‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å (‡∏Å‡∏Å.)</label><input class="fi" type="number" step="0.1" id="f-weight" onchange="calcBMI()"><div class="not-tested-wrap"><input type="checkbox" id="nt-weight" onchange="toggleField('f-weight','nt-weight')"><label for="nt-weight">‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏£‡∏ß‡∏à</label></div></div>
        <div class="fg"><label class="fl">‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏π‡∏á (‡∏ã‡∏°.)</label><input class="fi" type="number" step="0.1" id="f-height" onchange="calcBMI()"><div class="not-tested-wrap"><input type="checkbox" id="nt-height" onchange="toggleField('f-height','nt-height')"><label for="nt-height">‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏£‡∏ß‡∏à</label></div></div>
        <div class="fg"><label class="fl">‡∏£‡∏≠‡∏ö‡πÄ‡∏≠‡∏ß (‡∏ã‡∏°.)</label><input class="fi" type="number" step="0.1" id="f-waist"><div class="not-tested-wrap"><input type="checkbox" id="nt-waist" onchange="toggleField('f-waist','nt-waist')"><label for="nt-waist">‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏£‡∏ß‡∏à</label></div></div>
        <div class="fg"><label class="fl">BMI (‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥)</label><input class="fi" type="number" step="0.01" id="f-bmi" readonly style="background:#F9FAFB;"></div>
        <div class="fg"><label class="fl">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏±‡∏ô ‡∏ï‡∏±‡∏ß‡∏ö‡∏ô (mmHg)</label><input class="fi" type="number" id="f-bps"><div class="not-tested-wrap"><input type="checkbox" id="nt-bp" onchange="toggleField('f-bps','nt-bp');toggleField('f-bpd','nt-bp')"><label for="nt-bp">‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏£‡∏ß‡∏à</label></div></div>
        <div class="fg"><label class="fl">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏±‡∏ô ‡∏ï‡∏±‡∏ß‡∏•‡πà‡∏≤‡∏á (mmHg)</label><input class="fi" type="number" id="f-bpd"></div>
        <div class="fg"><label class="fl">‡∏ä‡∏µ‡∏û‡∏à‡∏£ (‡∏Ñ‡∏£‡∏±‡πâ‡∏á/‡∏ô‡∏≤‡∏ó‡∏µ)</label><input class="fi" type="number" id="f-pulse"><div class="not-tested-wrap"><input type="checkbox" id="nt-pulse" onchange="toggleField('f-pulse','nt-pulse')"><label for="nt-pulse">‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏£‡∏ß‡∏à</label></div></div>
      </div>

      <div class="sec-title">ü©∏ CBC ‡πÄ‡∏•‡∏∑‡∏≠‡∏î‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå</div>
      <div class="grid-form">
        <div class="fg"><label class="fl">Hemoglobin (g/dL)</label><input class="fi" type="number" step="0.1" id="f-hb"><div class="not-tested-wrap"><input type="checkbox" id="nt-cbc" onchange="['f-hb','f-hct','f-wbc','f-plt'].forEach(x=>toggleField(x,'nt-cbc'))"><label for="nt-cbc">‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏£‡∏ß‡∏à CBC ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</label></div></div>
        <div class="fg"><label class="fl">Hematocrit (%)</label><input class="fi" type="number" step="0.1" id="f-hct"></div>
        <div class="fg"><label class="fl">WBC (cells/ŒºL)</label><input class="fi" type="number" id="f-wbc"></div>
        <div class="fg"><label class="fl">Platelet (cells/ŒºL)</label><input class="fi" type="number" id="f-plt"></div>
      </div>

      <div class="sec-title">üç¨ ‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡∏• / ‡πÑ‡∏Ç‡∏°‡∏±‡∏ô</div>
      <div class="grid-form-3">
        <div class="fg"><label class="fl">FBS ‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡∏• (mg/dL)</label><input class="fi" type="number" step="0.1" id="f-fbs"><div class="not-tested-wrap"><input type="checkbox" id="nt-fbs" onchange="toggleField('f-fbs','nt-fbs')"><label for="nt-fbs">‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏£‡∏ß‡∏à</label></div></div>
        <div class="fg"><label class="fl">HbA1c (%)</label><input class="fi" type="number" step="0.1" id="f-hba1c"><div class="not-tested-wrap"><input type="checkbox" id="nt-hba1c" onchange="toggleField('f-hba1c','nt-hba1c')"><label for="nt-hba1c">‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏£‡∏ß‡∏à</label></div></div>
        <div class="fg"><label class="fl">Total Cholesterol (mg/dL)</label><input class="fi" type="number" step="0.1" id="f-chol"><div class="not-tested-wrap"><input type="checkbox" id="nt-lipid" onchange="['f-chol','f-hdl','f-ldl','f-tg'].forEach(x=>toggleField(x,'nt-lipid'))"><label for="nt-lipid">‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏£‡∏ß‡∏à Lipid Profile</label></div></div>
        <div class="fg"><label class="fl">HDL (mg/dL)</label><input class="fi" type="number" step="0.1" id="f-hdl"></div>
        <div class="fg"><label class="fl">LDL (mg/dL)</label><input class="fi" type="number" step="0.1" id="f-ldl"></div>
        <div class="fg"><label class="fl">Triglyceride (mg/dL)</label><input class="fi" type="number" step="0.1" id="f-tg"></div>
      </div>

      <div class="sec-title">ü´Å ‡∏ï‡∏±‡∏ö (Liver Function)</div>
      <div class="grid-form">
        <div class="fg"><label class="fl">AST/SGOT (U/L)</label><input class="fi" type="number" step="0.1" id="f-sgot"><div class="not-tested-wrap"><input type="checkbox" id="nt-liver" onchange="['f-sgot','f-sgpt','f-ggt','f-alp'].forEach(x=>toggleField(x,'nt-liver'))"><label for="nt-liver">‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏£‡∏ß‡∏à Liver Function ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</label></div></div>
        <div class="fg"><label class="fl">ALT/SGPT (U/L)</label><input class="fi" type="number" step="0.1" id="f-sgpt"></div>
        <div class="fg"><label class="fl">GGT (U/L)</label><input class="fi" type="number" step="0.1" id="f-ggt"></div>
        <div class="fg"><label class="fl">ALP (U/L)</label><input class="fi" type="number" step="0.1" id="f-alp"></div>
      </div>

      <div class="sec-title">ü´ò ‡πÑ‡∏ï (Kidney Function)</div>
      <div class="grid-form">
        <div class="fg"><label class="fl">Creatinine (mg/dL)</label><input class="fi" type="number" step="0.01" id="f-cr"><div class="not-tested-wrap"><input type="checkbox" id="nt-kidney" onchange="['f-cr','f-bun','f-ua'].forEach(x=>toggleField(x,'nt-kidney'))"><label for="nt-kidney">‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏£‡∏ß‡∏à Kidney Function</label></div></div>
        <div class="fg"><label class="fl">BUN (mg/dL)</label><input class="fi" type="number" step="0.1" id="f-bun"></div>
        <div class="fg"><label class="fl">Uric Acid (mg/dL)</label><input class="fi" type="number" step="0.1" id="f-ua"></div>
      </div>

      <div class="sec-title">üî¨ ‡∏ï‡∏£‡∏ß‡∏à‡∏õ‡∏±‡∏™‡∏™‡∏≤‡∏ß‡∏∞ (Urine Analysis)</div>
      <div class="grid-form">
        <div class="fg"><label class="fl">‡∏ú‡∏•‡∏ï‡∏£‡∏ß‡∏à‡∏õ‡∏±‡∏™‡∏™‡∏≤‡∏ß‡∏∞</label>
          <select class="fi" id="f-urine"><option value="">‚Äî ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ‚Äî</option><option>‡∏õ‡∏Å‡∏ï‡∏¥</option><option>‡∏û‡∏ö‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡∏• (Glycosuria)</option><option>‡∏û‡∏ö‡πÇ‡∏õ‡∏£‡∏ï‡∏µ‡∏ô (Proteinuria)</option><option>‡∏û‡∏ö‡πÄ‡∏°‡πá‡∏î‡πÄ‡∏•‡∏∑‡∏≠‡∏î‡πÅ‡∏î‡∏á</option><option>‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥ ‚Äî ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏≠‡∏∑‡πà‡∏ô</option></select>
          <div class="not-tested-wrap"><input type="checkbox" id="nt-urine" onchange="toggleField('f-urine','nt-urine')"><label for="nt-urine">‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏£‡∏ß‡∏à</label></div>
        </div>
        <div class="fg"><label class="fl">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡∏õ‡∏±‡∏™‡∏™‡∏≤‡∏ß‡∏∞</label><input class="fi" type="text" id="f-urine-note" placeholder="‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°"></div>
      </div>

      <div class="sec-title">‚ù§Ô∏è ‡∏Ñ‡∏•‡∏∑‡πà‡∏ô‡πÑ‡∏ü‡∏ü‡πâ‡∏≤‡∏´‡∏±‡∏ß‡πÉ‡∏à (EKG/ECG)</div>
      <div class="grid-form">
        <div class="fg"><label class="fl">‡∏ú‡∏• EKG</label>
          <select class="fi" id="f-ekg"><option value="">‚Äî ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ‚Äî</option><option>‡∏õ‡∏Å‡∏ï‡∏¥ (Normal Sinus Rhythm)</option><option>Sinus Tachycardia</option><option>Sinus Bradycardia</option><option>ST Depression</option><option>ST Elevation</option><option>LVH</option><option>‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥ ‚Äî ‡∏™‡πà‡∏á‡∏ï‡πà‡∏≠‡πÅ‡∏û‡∏ó‡∏¢‡πå</option><option>‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏£‡∏ß‡∏à</option></select>
          <div class="not-tested-wrap"><input type="checkbox" id="nt-ekg" onchange="toggleField('f-ekg','nt-ekg')"><label for="nt-ekg">‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏£‡∏ß‡∏à</label></div>
        </div>
      </div>

      <div class="sec-title">ü´Å X-Ray ‡∏õ‡∏≠‡∏î</div>
      <div class="grid-form">
        <div class="fg"><label class="fl">‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏≠‡πà‡∏≤‡∏ô‡∏ü‡∏¥‡∏•‡πå‡∏° X-Ray</label>
          <select class="fi" id="f-xray"><option value="">‚Äî ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ‚Äî</option><option>‡∏õ‡∏Å‡∏ï‡∏¥ (Normal)</option><option>‡∏û‡∏ö‡∏ù‡∏∏‡πà‡∏ô‡∏õ‡∏≠‡∏î (Pneumoconiosis)</option><option>‡∏û‡∏ö‡πÄ‡∏á‡∏≤‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥ ‚Äî ‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°</option><option>‡∏™‡∏á‡∏™‡∏±‡∏¢‡∏ß‡∏±‡∏ì‡πÇ‡∏£‡∏Ñ ‚Äî ‡∏™‡πà‡∏á‡∏ï‡πà‡∏≠</option><option>‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥‡∏≠‡∏∑‡πà‡∏ô‡πÜ</option><option>‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏£‡∏ß‡∏à</option></select>
          <div class="not-tested-wrap"><input type="checkbox" id="nt-xray" onchange="toggleField('f-xray','nt-xray')"><label for="nt-xray">‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏£‡∏ß‡∏à</label></div>
        </div>
        <div class="fg"><label class="fl">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏ X-Ray</label><input class="fi" type="text" id="f-xray-note"></div>
      </div>

      <div class="sec-title">üëÅÔ∏è ‡∏™‡∏≤‡∏¢‡∏ï‡∏≤ / ‡∏Å‡∏≤‡∏£‡πÑ‡∏î‡πâ‡∏¢‡∏¥‡∏ô</div>
      <div class="grid-form">
        <div class="fg"><label class="fl">‡∏ï‡∏≤‡∏Ç‡∏ß‡∏≤ (VA)</label><input class="fi" type="text" id="f-vr" placeholder="‡πÄ‡∏ä‡πà‡∏ô 20/20"><div class="not-tested-wrap"><input type="checkbox" id="nt-vision" onchange="['f-vr','f-vl'].forEach(x=>toggleField(x,'nt-vision'))"><label for="nt-vision">‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏£‡∏ß‡∏à</label></div></div>
        <div class="fg"><label class="fl">‡∏ï‡∏≤‡∏ã‡πâ‡∏≤‡∏¢ (VA)</label><input class="fi" type="text" id="f-vl" placeholder="‡πÄ‡∏ä‡πà‡∏ô 20/20"></div>
      </div>

      <div class="btn-row">
        <button class="btn-primary" onclick="saveAnnual()" id="btn-save-annual">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
        <button class="btn-sec" onclick="clearAnnualForm()">‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
      </div>
    </div>
  </div>
</div>

<!-- PAGE: ORG HEALTH (Annual module - all employees can see) -->
<div id="page-org-health" class="page">
  <div class="topbar">
    <div class="topbar-left">
      <span class="topbar-title">üìä ‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡∏≠‡∏á‡∏Ñ‡πå‡∏Å‡∏£‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°</span>
      <span class="module-tag tag-annual">‚óè ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏õ‡∏µ</span>
    </div>
  </div>
  <div class="pad">
    <div class="alert-warn">üîí ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏° ‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏£‡∏≤‡∏¢‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•</div>
    <div id="org-health-content"><div class="loading"><span class="spinner"></span>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div></div>
  </div>
</div>

<!-- PAGE: MY RISK -->
<div id="page-my-risk" class="page">
  <div class="topbar">
    <div class="topbar-left"><span class="topbar-title">‚ö†Ô∏è ‡∏ú‡∏•‡∏ï‡∏£‡∏ß‡∏à‡∏õ‡∏±‡∏à‡∏à‡∏±‡∏¢‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</span><span class="module-tag tag-risk">‚óè ‡∏ï‡∏£‡∏ß‡∏à‡∏ï‡∏≤‡∏°‡∏õ‡∏±‡∏à‡∏à‡∏±‡∏¢‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á</span></div>
  </div>
  <div class="pad"><div id="my-risk-content"><div class="loading"><span class="spinner"></span>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div></div></div>
</div>

<!-- PAGE: ENTER RISK -->
<div id="page-enter-risk" class="page">
  <div class="topbar">
    <div class="topbar-left"><span class="topbar-title">‚úèÔ∏è ‡∏•‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏£‡∏ß‡∏à‡∏õ‡∏±‡∏à‡∏à‡∏±‡∏¢‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á</span><span class="module-tag tag-risk">‚óè ‡∏ï‡∏£‡∏ß‡∏à‡∏ï‡∏≤‡∏°‡∏õ‡∏±‡∏à‡∏à‡∏±‡∏¢‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á</span></div>
  </div>
  <div class="pad">
    <div class="card">
      <div class="sec-title">üìÖ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ</div>
      <div class="grid-form">
        <div class="fg"><label class="fl">‡∏õ‡∏µ ‡∏û.‡∏®.</label><input class="fi" type="number" id="rf-year" value="2568"></div>
        <div class="fg"><label class="fl">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏ß‡∏à</label><input class="fi" type="date" id="rf-date"></div>
        <div class="fg"><label class="fl">‡∏™‡∏ñ‡∏≤‡∏ô‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•</label><input class="fi" type="text" id="rf-hospital"></div>
        <div class="fg"><label class="fl">‡πÅ‡∏û‡∏ó‡∏¢‡πå‡∏ú‡∏π‡πâ‡∏ï‡∏£‡∏ß‡∏à</label><input class="fi" type="text" id="rf-doctor"></div>
      </div>
      <div class="sec-title">üëÇ ‡∏Å‡∏≤‡∏£‡πÑ‡∏î‡πâ‡∏¢‡∏¥‡∏ô (Audiometry)</div>
      <div class="grid-form-3">
        <div class="fg"><label class="fl">‡∏´‡∏π‡∏Ç‡∏ß‡∏≤ (dB HL)</label><input class="fi" type="number" id="rf-hr"><div class="not-tested-wrap"><input type="checkbox" id="nt-hearing" onchange="['rf-hr','rf-hl'].forEach(x=>toggleField(x,'nt-hearing'))"><label for="nt-hearing">‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏£‡∏ß‡∏à</label></div></div>
        <div class="fg"><label class="fl">‡∏´‡∏π‡∏ã‡πâ‡∏≤‡∏¢ (dB HL)</label><input class="fi" type="number" id="rf-hl"></div>
        <div class="fg"><label class="fl">‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡πÑ‡∏î‡πâ‡∏¢‡∏¥‡∏ô</label><select class="fi" id="rf-hres"><option>‡∏õ‡∏Å‡∏ï‡∏¥</option><option>‡∏™‡∏π‡∏ç‡πÄ‡∏™‡∏µ‡∏¢‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢ (26-40 dB)</option><option>‡∏™‡∏π‡∏ç‡πÄ‡∏™‡∏µ‡∏¢‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á (41-55 dB)</option><option>‡∏™‡∏π‡∏ç‡πÄ‡∏™‡∏µ‡∏¢‡∏°‡∏≤‡∏Å (>55 dB)</option><option>‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏£‡∏ß‡∏à</option></select></div>
      </div>
      <div class="sec-title">ü´Å ‡∏™‡∏°‡∏£‡∏£‡∏ñ‡∏†‡∏≤‡∏û‡∏õ‡∏≠‡∏î (Spirometry)</div>
      <div class="grid-form-3">
        <div class="fg"><label class="fl">FVC (% predicted)</label><input class="fi" type="number" step="0.1" id="rf-fvc"><div class="not-tested-wrap"><input type="checkbox" id="nt-lung" onchange="['rf-fvc','rf-fev1'].forEach(x=>toggleField(x,'nt-lung'))"><label for="nt-lung">‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏£‡∏ß‡∏à</label></div></div>
        <div class="fg"><label class="fl">FEV1 (% predicted)</label><input class="fi" type="number" step="0.1" id="rf-fev1"></div>
        <div class="fg"><label class="fl">‡∏ú‡∏•‡∏™‡∏°‡∏£‡∏£‡∏ñ‡∏†‡∏≤‡∏û‡∏õ‡∏≠‡∏î</label><select class="fi" id="rf-lres"><option>‡∏õ‡∏Å‡∏ï‡∏¥</option><option>Restrictive pattern</option><option>Obstructive pattern</option><option>Mixed pattern</option><option>‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏£‡∏ß‡∏à</option></select></div>
      </div>
      <div class="sec-title">‚öóÔ∏è ‡∏™‡∏≤‡∏£‡πÄ‡∏Ñ‡∏°‡∏µ</div>
      <div class="grid-form">
        <div class="fg"><label class="fl">‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏ß‡∏à</label><input class="fi" type="text" id="rf-chem" placeholder="‡πÄ‡∏ä‡πà‡∏ô Toluene, Lead, Benzene"></div>
        <div class="fg"><label class="fl">‡∏ú‡∏•‡∏ï‡∏£‡∏ß‡∏à</label><input class="fi" type="text" id="rf-cres"><div class="not-tested-wrap"><input type="checkbox" id="nt-chem" onchange="['rf-chem','rf-cres','rf-cunit','rf-cref'].forEach(x=>toggleField(x,'nt-chem'))"><label for="nt-chem">‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏£‡∏ß‡∏à</label></div></div>
        <div class="fg"><label class="fl">‡∏´‡∏ô‡πà‡∏ß‡∏¢</label><input class="fi" type="text" id="rf-cunit" placeholder="‡πÄ‡∏ä‡πà‡∏ô ppm, Œºg/dL"></div>
        <div class="fg"><label class="fl">‡∏Ñ‡πà‡∏≤‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á (TLV)</label><input class="fi" type="text" id="rf-cref" placeholder="‡πÄ‡∏ä‡πà‡∏ô <50 ppm"></div>
      </div>
      <div class="sec-title">‚ù§Ô∏è EKG / ‡πÑ‡∏ï / BMI</div>
      <div class="grid-form-3">
        <div class="fg"><label class="fl">‡∏ú‡∏• EKG</label><select class="fi" id="rf-ekg"><option>‡∏õ‡∏Å‡∏ï‡∏¥</option><option>‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥</option><option>‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏£‡∏ß‡∏à</option></select></div>
        <div class="fg"><label class="fl">Creatinine (mg/dL)</label><input class="fi" type="number" step="0.01" id="rf-cr"><div class="not-tested-wrap"><input type="checkbox" id="nt-rfkidney" onchange="toggleField('rf-cr','nt-rfkidney')"><label for="nt-rfkidney">‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏£‡∏ß‡∏à</label></div></div>
        <div class="fg"><label class="fl">BMI</label><input class="fi" type="number" step="0.1" id="rf-bmi"></div>
      </div>
      <div class="sec-title">üìä ‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•</div>
      <div class="grid-form">
        <div class="fg"><label class="fl">‡∏ú‡∏•‡∏£‡∏ß‡∏°</label><select class="fi" id="rf-overall"><option>‡∏õ‡∏Å‡∏ï‡∏¥</option><option>‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥ ‚Äî ‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°</option><option>‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥ ‚Äî ‡∏™‡πà‡∏á‡∏ï‡πà‡∏≠‡πÅ‡∏û‡∏ó‡∏¢‡πå</option></select></div>
        <div class="fg"><label class="fl">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</label><input class="fi" type="text" id="rf-notes"></div>
      </div>
      <div class="btn-row">
        <button class="btn-primary" onclick="saveRisk()" id="btn-save-risk">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
        <button class="btn-sec" onclick="clearRiskForm()">‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
      </div>
    </div>
  </div>
</div>

<!-- PAGE: OVERVIEW (Admin) -->
<div id="page-overview" class="page">
  <div class="topbar">
    <div class="topbar-left"><span class="topbar-title">üìä ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡∏≠‡∏á‡∏Ñ‡πå‡∏Å‡∏£</span><span class="module-tag tag-admin">üëë Admin</span></div>
  </div>
  <div class="pad">
    <div class="alert-warn">üîí ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥ ‡πÑ‡∏°‡πà‡πÅ‡∏™‡∏î‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏£‡∏≤‡∏¢‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•</div>
    <div id="overview-content"><div class="loading"><span class="spinner"></span>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div></div>
  </div>
</div>

<!-- PAGE: REPORT (Admin) -->
<div id="page-report" class="page">
  <div class="topbar">
    <div class="topbar-left"><span class="topbar-title">üìÑ ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ï‡∏≤‡∏°‡∏Å‡∏é‡∏´‡∏°‡∏≤‡∏¢</span><span class="module-tag tag-admin">üëë Admin</span></div>
  </div>
  <div class="pad">
    <div class="grid-3">
      <div class="card" style="cursor:pointer;transition:.2s" onmouseover="this.style.transform='translateY(-3px)'" onmouseout="this.style.transform=''">
        <div style="font-size:30px;margin-bottom:10px;">üìÑ</div>
        <div style="font-family:'Prompt',sans-serif;font-weight:600;margin-bottom:5px;">‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ú‡∏•‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û</div>
        <div style="font-size:12px;color:var(--sub);">‡∏ï‡∏≤‡∏°‡∏Å‡∏é‡∏Å‡∏£‡∏∞‡∏ó‡∏£‡∏ß‡∏á‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏¥‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡∏∞‡∏Ñ‡∏∏‡πâ‡∏°‡∏Ñ‡∏£‡∏≠‡∏á‡πÅ‡∏£‡∏á‡∏á‡∏≤‡∏ô</div>
        <button class="btn-primary" style="margin-top:12px;padding:8px 14px;font-size:12px;" onclick="showNotif('üì• ‡∏ü‡∏µ‡πÄ‡∏à‡∏≠‡∏£‡πå Export ‡∏à‡∏∞‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ô‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô‡∏ñ‡∏±‡∏î‡πÑ‡∏õ','success')">üì• Export Excel</button>
      </div>
      <div class="card" style="cursor:pointer;transition:.2s" onmouseover="this.style.transform='translateY(-3px)'" onmouseout="this.style.transform=''">
        <div style="font-size:30px;margin-bottom:10px;">‚ö†Ô∏è</div>
        <div style="font-family:'Prompt',sans-serif;font-weight:600;margin-bottom:5px;">‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏±‡∏¢‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á</div>
        <div style="font-size:12px;color:var(--sub);">‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡∏ï‡∏£‡∏ß‡∏à‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á</div>
        <button class="btn-primary" style="margin-top:12px;padding:8px 14px;font-size:12px;" onclick="showNotif('üì• ‡∏ü‡∏µ‡πÄ‡∏à‡∏≠‡∏£‡πå Export ‡∏à‡∏∞‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ô‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô‡∏ñ‡∏±‡∏î‡πÑ‡∏õ','success')">üì• Export Excel</button>
      </div>
      <div class="card" style="cursor:pointer;transition:.2s" onmouseover="this.style.transform='translateY(-3px)'" onmouseout="this.style.transform=''">
        <div style="font-size:30px;margin-bottom:10px;">üè•</div>
        <div style="font-family:'Prompt',sans-serif;font-weight:600;margin-bottom:5px;">‡∏™‡πà‡∏á‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô</div>
        <div style="font-size:12px;color:var(--sub);">‡∏Å‡∏£‡∏°‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏¥‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡∏∞‡∏Ñ‡∏∏‡πâ‡∏°‡∏Ñ‡∏£‡∏≠‡∏á‡πÅ‡∏£‡∏á‡∏á‡∏≤‡∏ô</div>
        <button class="btn-sec" style="margin-top:12px;padding:8px 14px;font-size:12px;">üì§ ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</button>
      </div>
    </div>
  </div>
</div>

<!-- PAGE: RISK DASHBOARD -->
<div id="page-risk-dash" class="page">
  <div class="topbar">
    <div class="topbar-left">
      <span class="topbar-title">üè† ‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î‡∏õ‡∏±‡∏à‡∏à‡∏±‡∏¢‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</span>
      <span class="module-tag tag-risk">‚óè ‡∏ï‡∏£‡∏ß‡∏à‡∏ï‡∏≤‡∏°‡∏õ‡∏±‡∏à‡∏à‡∏±‡∏¢‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á</span>
    </div>
    <div class="ytabs" id="risk-dash-ytabs"></div>
  </div>
  <div class="pad" id="risk-dash-content">
    <div class="loading"><span class="spinner"></span>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>
  </div>
</div>

<!-- PAGE: ADMIN -->
<div id="page-admin" class="page">
  <div class="topbar">
    <div class="topbar-left">
      <span class="topbar-title">üëë ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡∏ö‡∏ö Admin</span>
      <span class="module-tag tag-admin">‚óè Admin Only</span>
    </div>
  </div>
  <div class="pad">
    <div class="admin-tabs">
      <div class="admin-tab active" id="atab-emp" onclick="switchAdminTab('emp')">üë• ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</div>
      <div class="admin-tab" id="atab-annual" onclick="switchAdminTab('annual')">üè• ‡∏ú‡∏•‡∏ï‡∏£‡∏ß‡∏à‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏õ‡∏µ (‡∏£‡∏≤‡∏¢‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•)</div>
      <div class="admin-tab" id="atab-risk" onclick="switchAdminTab('risk')">‚ö†Ô∏è ‡∏ú‡∏•‡∏ï‡∏£‡∏ß‡∏à‡∏õ‡∏±‡∏à‡∏à‡∏±‡∏¢‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á (‡∏£‡∏≤‡∏¢‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•)</div>
      <div class="admin-tab" id="atab-export" onclick="switchAdminTab('export')">üì• Export ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</div>
      <div class="admin-tab" id="atab-passwd" onclick="switchAdminTab('passwd')">üîë ‡∏Ñ‡∏π‡πà‡∏°‡∏∑‡∏≠‡∏•‡∏∑‡∏°‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</div>
    </div>
    <div id="admin-content"><div class="loading"><span class="spinner"></span>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div></div>
  </div>
</div>

<!-- MODAL CONTAINER -->
<div id="modal-bg" class="modal-bg" style="display:none" onclick="if(event.target===this)closeModal()">
  <div class="modal" id="modal-box">
    <button class="modal-close" onclick="closeModal()">‚úï</button>
    <div id="modal-content"></div>
  </div>
</div>
```

  </div><!-- /content -->
</div><!-- /main-screen -->
</div><!-- /app -->

<div class="notif" id="notif"></div>

<script>
// ===== SUPABASE + CONFIG =====
let sb = null, currentUser = null, annualData = [], selectedYear = null;
let dashCharts = {}, riskData = [], editingRiskId = null, editingAnnualId = null;

function saveConfig() {
  const url = document.getElementById('sb-url').value.trim();
  const key = document.getElementById('sb-key').value.trim();
  const aik = document.getElementById('ai-key').value.trim();
  if (!url || !key) { alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å URL ‡πÅ‡∏•‡∏∞ Key'); return; }
  localStorage.setItem('sb_url', url);
  localStorage.setItem('sb_key', key);
  if (aik) localStorage.setItem('ai_key', aik);
  sb = window.supabase.createClient(url, key);
  document.getElementById('config-banner').style.display = 'none';
  showNotif('‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', 'success');
}

window.onload = () => {
  const url = localStorage.getItem('sb_url');
  const key = localStorage.getItem('sb_key');
  if (url && key) {
    document.getElementById('sb-url').value = url;
    document.getElementById('sb-key').value = key;
    const aik = localStorage.getItem('ai_key');
    if (aik) document.getElementById('ai-key').value = aik;
    sb = window.supabase.createClient(url, key);
    document.getElementById('config-banner').style.display = 'none';
  }
  const today = new Date().toISOString().split('T')[0];
  document.getElementById('f-date').value = today;
  document.getElementById('rf-date').value = today;
};

// ===== AUTH =====
let currentTab = 'annual';
function setTab(t) {
  currentTab = t;
  document.getElementById('tab-annual').classList.toggle('active', t === 'annual');
  document.getElementById('tab-risk').classList.toggle('active', t === 'risk');
}

async function doLogin() {
  const empId = document.getElementById('l-empid').value.trim().toUpperCase();
  const pass = document.getElementById('l-pass').value;
  const errEl = document.getElementById('login-err');
  const btn = document.getElementById('btn-login-submit');
  if (!empId || !pass) { errEl.textContent = '‚ùó ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö'; return; }
  btn.textContent = '‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö...'; btn.disabled = true; errEl.textContent = '';
  try {
    if (!sb) throw new Error('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Supabase ‚Äî ‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡πÅ‡∏ñ‡∏ö‡∏™‡∏µ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô');
    const { data, error } = await sb.from('employees').select('*').eq('emp_id', empId).single();
    if (error || !data) { errEl.textContent = '‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô'; return; }
    if (data.password_hash !== pass) { errEl.textContent = '‚ùå ‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á'; return; }
    if (currentTab === 'risk' && data.role !== 'admin') { errEl.textContent = '‚ùå ‡∏´‡∏ô‡πâ‡∏≤‡∏õ‡∏±‡∏à‡∏à‡∏±‡∏¢‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á Admin ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô'; return; }
    currentUser = data;
    document.getElementById('sb-name').textContent = data.full_name;
    document.getElementById('sb-id').textContent = data.emp_id + ' ¬∑ ' + (data.department || '');
    document.getElementById('sb-avatar').textContent = data.full_name[2] || '‡∏Å';
    const isAdmin = data.role === 'admin';
    // Toggle sidebar sections based on module
    document.getElementById('sidebar-annual-nav').style.display = currentTab === 'annual' ? 'block' : 'none';
    document.getElementById('sidebar-risk-nav').style.display = currentTab === 'risk' ? 'block' : 'none';
    if (currentTab === 'risk') {
      document.getElementById('nv-overview').style.display = isAdmin ? 'flex' : 'none';
      document.getElementById('nv-report').style.display = isAdmin ? 'flex' : 'none';
      document.getElementById('nv-admin').style.display = isAdmin ? 'flex' : 'none';
    }
    document.getElementById('login-screen').classList.remove('active');
    document.getElementById('main-screen').classList.add('active');
    if (currentTab === 'annual') { goto('dashboard'); }
    else { goto('risk-dash'); }
    showNotif(`‚úÖ ‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö ${data.full_name}`, 'success');
  } catch(e) { errEl.textContent = '‚ùå ' + e.message; }
  btn.textContent = 'üîê ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö'; btn.disabled = false;
}

function doLogout() {
  currentUser = null; annualData = []; selectedYear = null; riskData = [];
  Object.values(dashCharts).forEach(c => { try { c.destroy(); } catch(e){} });
  dashCharts = {};
  document.getElementById('main-screen').classList.remove('active');
  document.getElementById('login-screen').classList.add('active');
  document.getElementById('l-pass').value = '';
  document.getElementById('login-err').textContent = '';
}

function goto(page) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.nv').forEach(n => n.classList.remove('active'));
  const pageEl = document.getElementById('page-' + page);
  if (pageEl) pageEl.classList.add('active');
  const nvEl = document.getElementById('nv-' + page);
  if (nvEl) nvEl.classList.add('active');
  if (page === 'dashboard') loadDashboard();
  else if (page === 'results') loadResults();
  else if (page === 'ai') loadAIPage();
  else if (page === 'org-health') loadOrgHealth();
  else if (page === 'risk-dash') loadRiskDash();
  else if (page === 'my-risk') loadMyRisk();
  else if (page === 'overview') loadOverview();
  else if (page === 'admin') { loadAdmin(); }
}

// ===== FORM HELPERS =====
function toggleField(fieldId, cbId) {
  const cb = document.getElementById(cbId);
  const fi = document.getElementById(fieldId);
  if (!fi) return;
  fi.disabled = cb.checked;
  if (cb.checked) { fi.value = ''; fi.dataset.notTested = '1'; }
  else { delete fi.dataset.notTested; }
}

function calcBMI() {
  const w = parseFloat(document.getElementById('f-weight').value);
  const h = parseFloat(document.getElementById('f-height').value) / 100;
  if (w && h) document.getElementById('f-bmi').value = (w / (h * h)).toFixed(2);
}

// ===== STATUS HELPERS (‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô‡∏™‡∏≤‡∏ò‡∏≤‡∏£‡∏ì‡∏™‡∏∏‡∏Ç‡πÑ‡∏ó‡∏¢) =====
function bmiStatus(b) {
  if (!b) return '<span class="badge b-gray">‚Äî</span>';
  if (b < 18.5) return '<span class="badge b-info">‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏ô‡πâ‡∏≠‡∏¢‡∏Å‡∏ß‡πà‡∏≤‡πÄ‡∏Å‡∏ì‡∏ë‡πå</span>';
  if (b < 23.0) return '<span class="badge b-ok">‡∏õ‡∏Å‡∏ï‡∏¥ (18.5-22.9)</span>';
  if (b < 25.0) return '<span class="badge b-warn">‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡πÄ‡∏Å‡∏¥‡∏ô (23-24.9)</span>';
  if (b < 30.0) return '<span class="badge b-warn">‡∏≠‡πâ‡∏ß‡∏ô‡∏£‡∏∞‡∏î‡∏±‡∏ö 1 (25-29.9)</span>';
  return '<span class="badge b-danger">‡∏≠‡πâ‡∏ß‡∏ô‡∏£‡∏∞‡∏î‡∏±‡∏ö 2 (‚â•30)</span>';
}
function waistStatus(w, gender) {
  if (!w) return '<span class="badge b-gray">‚Äî</span>';
  const limit = (gender === 'female') ? 80 : 90;
  if (w > limit) return `<span class="badge b-danger">‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡πÇ‡∏£‡∏Ñ‡πÄ‡∏°‡∏ï‡∏≤‡∏ö‡∏≠‡∏•‡∏¥‡∏Å (>${limit}‡∏ã‡∏°.)</span>`;
  return '<span class="badge b-ok">‡∏õ‡∏Å‡∏ï‡∏¥</span>';
}
function bpStatus(s) {
  if (!s) return '<span class="badge b-gray">‚Äî</span>';
  if (s < 120) return '<span class="badge b-ok">‡∏õ‡∏Å‡∏ï‡∏¥ (<120)</span>';
  if (s < 130) return '<span class="badge b-info">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏±‡∏ô‡∏™‡∏π‡∏á‡∏õ‡∏Å‡∏ï‡∏¥ (120-129)</span>';
  if (s < 140) return '<span class="badge b-warn">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏±‡∏ô‡∏™‡∏π‡∏á‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏µ‡πà 1 (130-139)</span>';
  if (s < 180) return '<span class="badge b-danger">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏±‡∏ô‡∏™‡∏π‡∏á‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏µ‡πà 2 (140-179)</span>';
  return '<span class="badge b-danger">‡∏ß‡∏¥‡∏Å‡∏§‡∏ï (‚â•180)</span>';
}
function fbsStatus(v) {
  if (!v) return '<span class="badge b-gray">‚Äî</span>';
  if (v < 100) return '<span class="badge b-ok">‡∏õ‡∏Å‡∏ï‡∏¥ (<100)</span>';
  if (v < 126) return '<span class="badge b-warn">‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡πÄ‡∏ö‡∏≤‡∏´‡∏ß‡∏≤‡∏ô/Prediabetes (100-125)</span>';
  return '<span class="badge b-danger">‡∏™‡∏á‡∏™‡∏±‡∏¢‡πÄ‡∏ö‡∏≤‡∏´‡∏ß‡∏≤‡∏ô (‚â•126)</span>';
}
function cholStatus(v) {
  if (!v) return '<span class="badge b-gray">‚Äî</span>';
  if (v < 200) return '<span class="badge b-ok">‡∏õ‡∏Å‡∏ï‡∏¥ (<200)</span>';
  if (v < 240) return '<span class="badge b-warn">‡∏Ñ‡πà‡∏≠‡∏ô‡∏Ç‡πâ‡∏≤‡∏á‡∏™‡∏π‡∏á (200-239)</span>';
  return '<span class="badge b-danger">‡∏™‡∏π‡∏á‡∏°‡∏≤‡∏Å (‚â•240)</span>';
}
function tgStatus(v) {
  if (!v) return '<span class="badge b-gray">‚Äî</span>';
  if (v < 150) return '<span class="badge b-ok">‡∏õ‡∏Å‡∏ï‡∏¥ (<150)</span>';
  if (v < 200) return '<span class="badge b-warn">‡∏Ñ‡πà‡∏≠‡∏ô‡∏Ç‡πâ‡∏≤‡∏á‡∏™‡∏π‡∏á (150-199)</span>';
  if (v < 500) return '<span class="badge b-danger">‡∏™‡∏π‡∏á (200-499)</span>';
  return '<span class="badge b-danger">‡∏™‡∏π‡∏á‡∏°‡∏≤‡∏Å (‚â•500)</span>';
}
function hdlStatus(v, gender) {
  if (!v) return '<span class="badge b-gray">‚Äî</span>';
  const low = (gender === 'female') ? 50 : 40;
  if (v < low) return `<span class="badge b-danger">‡∏ï‡πà‡∏≥ (<${low}) ‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏´‡∏±‡∏ß‡πÉ‡∏à</span>`;
  if (v >= 60) return '<span class="badge b-ok">‡∏î‡∏µ‡∏°‡∏≤‡∏Å (‚â•60) ‡∏õ‡∏Å‡∏õ‡πâ‡∏≠‡∏á‡∏´‡∏±‡∏ß‡πÉ‡∏à</span>';
  return '<span class="badge b-ok">‡∏õ‡∏Å‡∏ï‡∏¥</span>';
}
function ldlStatus(v) {
  if (!v) return '<span class="badge b-gray">‚Äî</span>';
  if (v < 100) return '<span class="badge b-ok">‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°‡∏°‡∏≤‡∏Å (<100)</span>';
  if (v < 130) return '<span class="badge b-ok">‡∏õ‡∏Å‡∏ï‡∏¥ (100-129)</span>';
  if (v < 160) return '<span class="badge b-warn">‡∏Ñ‡πà‡∏≠‡∏ô‡∏Ç‡πâ‡∏≤‡∏á‡∏™‡∏π‡∏á (130-159)</span>';
  return '<span class="badge b-danger">‡∏™‡∏π‡∏á (‚â•160)</span>';
}
function liverStatus(ast, alt) {
  if (!ast && !alt) return '<span class="badge b-gray">‚Äî</span>';
  const ulnA = 40, ulnB = 40;
  if (ast > ulnA * 3 || alt > ulnB * 3) return '<span class="badge b-danger">‡∏™‡∏π‡∏á‡∏°‡∏≤‡∏Å (>3x ULN)</span>';
  if (ast > ulnA || alt > ulnB) return '<span class="badge b-warn">‡∏™‡∏π‡∏á (>40 U/L)</span>';
  return '<span class="badge b-ok">‡∏õ‡∏Å‡∏ï‡∏¥ (‚â§40 U/L)</span>';
}
function creatinineStatus(v) {
  if (!v) return '<span class="badge b-gray">‚Äî</span>';
  if (v > 1.5) return '<span class="badge b-danger">‡∏™‡∏π‡∏á‡∏°‡∏≤‡∏Å ‚Äî ‡πÑ‡∏ï‡∏ö‡∏Å‡∏û‡∏£‡πà‡∏≠‡∏á</span>';
  if (v > 1.2) return '<span class="badge b-warn">‡∏™‡∏π‡∏á (>1.2)</span>';
  return '<span class="badge b-ok">‡∏õ‡∏Å‡∏ï‡∏¥ (0.7-1.2)</span>';
}
function hbStatus(v) {
  if (!v) return '<span class="badge b-gray">‚Äî</span>';
  if (v < 11) return '<span class="badge b-danger">‡∏ã‡∏µ‡∏î‡∏°‡∏≤‡∏Å (<11)</span>';
  if (v < 13.5) return '<span class="badge b-warn">‡∏ã‡∏µ‡∏î (‡∏ä‡∏≤‡∏¢<13.5 / ‡∏´‡∏ç‡∏¥‡∏á<12)</span>';
  if (v > 17.5) return '<span class="badge b-warn">‡∏™‡∏π‡∏á (>17.5)</span>';
  return '<span class="badge b-ok">‡∏õ‡∏Å‡∏ï‡∏¥ (13.5-17.5)</span>';
}

// ===== SCORING SYSTEM =====
const SCORE_SYSTEM = {
  bp: { weight: 20, fn: (s) => { if (!s) return 1; if (s < 120) return 1; if (s < 130) return 0.85; if (s < 140) return 0.6; if (s < 180) return 0.3; return 0; } },
  fbs: { weight: 20, fn: (v) => { if (!v) return 1; if (v < 100) return 1; if (v < 110) return 0.8; if (v < 126) return 0.5; return 0; } },
  bmi: { weight: 15, fn: (b) => { if (!b) return 1; if (b >= 18.5 && b < 23) return 1; if (b < 25) return 0.8; if (b < 18.5) return 0.7; if (b < 30) return 0.5; return 0.2; } },
  chol: { weight: 10, fn: (v) => { if (!v) return 1; if (v < 200) return 1; if (v < 240) return 0.7; return 0.3; } },
  tg: { weight: 5, fn: (v) => { if (!v) return 1; if (v < 150) return 1; if (v < 200) return 0.7; return 0.3; } },
  hdl: { weight: 5, fn: (v) => { if (!v) return 1; if (v >= 60) return 1; if (v >= 40) return 0.8; return 0.3; } },
  liver: { weight: 10, fn: (ast, alt) => { if (!ast && !alt) return 1; if (ast > 120 || alt > 120) return 0.2; if (ast > 40 || alt > 40) return 0.6; return 1; } },
  kidney: { weight: 10, fn: (cr) => { if (!cr) return 1; if (cr > 1.5) return 0.2; if (cr > 1.2) return 0.6; return 1; } },
  ekg: { weight: 5, fn: (e) => { if (!e || e === '‡∏õ‡∏Å‡∏ï‡∏¥ (Normal Sinus Rhythm)' || e === '‡∏õ‡∏Å‡∏ï‡∏¥') return 1; if (e && e.includes('‡∏™‡πà‡∏á‡∏ï‡πà‡∏≠')) return 0.2; return 0.6; } },
};

function calcScore(d) {
  const s = SCORE_SYSTEM;
  const score =
    s.bp.weight * s.bp.fn(d.bp_systolic) +
    s.fbs.weight * s.fbs.fn(d.fbs) +
    s.bmi.weight * s.bmi.fn(d.bmi) +
    s.chol.weight * s.chol.fn(d.total_cholesterol) +
    s.tg.weight * s.tg.fn(d.triglyceride) +
    s.hdl.weight * s.hdl.fn(d.hdl) +
    s.liver.weight * s.liver.fn(d.sgot, d.sgpt) +
    s.kidney.weight * s.kidney.fn(d.creatinine) +
    s.ekg.weight * s.ekg.fn(d.ekg_result);
  return Math.round(Math.min(100, Math.max(0, score)));
}

function scoreLabel(s) {
  if (s >= 90) return { label: '‡∏î‡∏µ‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°', color: '#059669' };
  if (s >= 75) return { label: '‡∏î‡∏µ', color: '#16A34A' };
  if (s >= 60) return { label: '‡∏û‡∏≠‡πÉ‡∏ä‡πâ', color: '#D97706' };
  if (s >= 40) return { label: '‡∏ï‡πâ‡∏≠‡∏á‡∏î‡∏π‡πÅ‡∏•', color: '#EA580C' };
  return { label: '‡∏ï‡πâ‡∏≠‡∏á‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á', color: '#DC2626' };
}

// ===== DASHBOARD =====
async function loadDashboard() {
  const el = document.getElementById('dash-content');
  el.innerHTML = '<div class="loading"><span class="spinner"></span>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</div>';
  try {
    if (!sb) throw new Error('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Supabase');
    const { data } = await sb.from('annual_checkup').select('*').eq('emp_id', currentUser.emp_id).order('checkup_year', { ascending: false });
    annualData = data || [];
    if (!annualData.length) {
      el.innerHTML = `<div class="empty"><div class="empty-ico">üìã</div><h3>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏•‡∏ï‡∏£‡∏ß‡∏à</h3><p style="margin:8px 0 20px">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏•‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡∏Å‡πà‡∏≠‡∏ô‡∏ô‡∏∞‡∏Ñ‡∏£‡∏±‡∏ö</p><button class="btn-primary" onclick="goto('enter-annual')">‚úèÔ∏è ‡∏•‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏•‡∏¢</button></div>`;
      return;
    }
    selectedYear = annualData[0].checkup_year;
    annualData.forEach(d => { if (!d.ai_score) d.ai_score = calcScore(d); });
    renderDashboard();
  } catch(e) {
    el.innerHTML = `<div class="empty"><div class="empty-ico">‚ö†Ô∏è</div><h3>${e.message}</h3></div>`;
  }
}

function renderDashboard() {
  const el = document.getElementById('dash-content');
  const d = annualData.find(r => r.checkup_year === selectedYear) || annualData[0];
  const score = d.ai_score || calcScore(d);
  const { label: slabel, color: scolor } = scoreLabel(score);
  const dashOffset = 339 - (339 * score / 100);

  const ytabsEl = document.getElementById('dash-ytabs');
  ytabsEl.innerHTML = annualData.map(r => `<div class="ytab ${r.checkup_year === selectedYear ? 'active' : ''}" onclick="selectedYear=${r.checkup_year};renderDashboard()">${r.checkup_year}</div>`).join('');

  const prev = annualData.find(r => r.checkup_year === selectedYear - 1);
  const trendArrow = (cur, prv, field, reverse = false) => {
    if (!prv || !cur[field] || !prv[field]) return '';
    const diff = cur[field] - prv[field];
    if (Math.abs(diff) < 1) return ' <span style="color:var(--sub);font-size:11px;">‚Üí</span>';
    const up = diff > 0;
    const good = reverse ? !up : up;
    return `<span style="font-size:11px;" class="${good ? 'trend-down' : 'trend-up'}">${up ? '‚ñ≤' : '‚ñº'}${Math.abs(diff).toFixed(1)}</span>`;
  };

  el.innerHTML = `
  <div class="grid-4">
    <div class="stat-card"><div class="stat-ico">‚öñÔ∏è</div><div class="stat-lbl">BMI</div>
      <div class="stat-val">${d.bmi||'‚Äî'} ${trendArrow(d,prev,'bmi',true)}</div>
      <div style="font-size:11px;color:var(--sub);margin-top:2px;">${d.weight||'‚Äî'}‡∏Å‡∏Å. / ${d.height||'‚Äî'}‡∏ã‡∏°.</div>${bmiStatus(d.bmi)}</div>
    <div class="stat-card"><div class="stat-ico">ü©∏</div><div class="stat-lbl">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏±‡∏ô</div>
      <div class="stat-val">${d.bp_systolic||'‚Äî'}<span class="stat-unit">/${d.bp_diastolic||'‚Äî'}</span> ${trendArrow(d,prev,'bp_systolic',true)}</div>
      <div style="font-size:11px;color:var(--sub);margin-top:2px;">mmHg</div>${bpStatus(d.bp_systolic)}</div>
    <div class="stat-card"><div class="stat-ico">üç¨</div><div class="stat-lbl">‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡∏• FBS</div>
      <div class="stat-val">${d.fbs||'‚Äî'}<span class="stat-unit">mg/dL</span> ${trendArrow(d,prev,'fbs',true)}</div>
      ${fbsStatus(d.fbs)}</div>
    <div class="stat-card"><div class="stat-ico">üíõ</div><div class="stat-lbl">‡∏Ñ‡∏≠‡πÄ‡∏•‡∏™‡πÄ‡∏ï‡∏≠‡∏£‡∏≠‡∏•</div>
      <div class="stat-val">${d.total_cholesterol||'‚Äî'}<span class="stat-unit">mg/dL</span> ${trendArrow(d,prev,'total_cholesterol',true)}</div>
      ${cholStatus(d.total_cholesterol)}</div>
  </div>

  <div class="grid-21">
    <div class="card">
      <div class="card-title">üìà ‡∏Å‡∏£‡∏≤‡∏ü‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á & ‡∏û‡∏¢‡∏≤‡∏Å‡∏£‡∏ì‡πå‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏°</div>
      <div class="chart-wrap"><canvas id="chart-score"></canvas></div>
    </div>
    <div class="card" style="display:flex;flex-direction:column;align-items:center;">
      <div class="card-title" style="align-self:flex-start;">üèÖ ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û ‡∏õ‡∏µ ${selectedYear}</div>
      <div class="ring-wrap">
        <div class="ring-container">
          <svg class="ring-svg" viewBox="0 0 120 120">
            <circle class="ring-bg-c" cx="60" cy="60" r="54"/>
            <circle class="ring-fill-c" cx="60" cy="60" r="54" stroke="${scolor}" stroke-dashoffset="${dashOffset}"/>
          </svg>
          <div class="ring-txt">
            <div class="ring-num" style="color:${scolor}">${score}</div>
            <div class="ring-sub-txt">/ 100</div>
          </div>
        </div>
        <div style="text-align:center;margin-top:8px;">
          <div style="font-family:'Prompt',sans-serif;font-size:16px;font-weight:700;color:${scolor}">${slabel}</div>
          <div style="font-size:11px;color:var(--sub);margin-top:3px;">${dateTH(d.checkup_date)}</div>
          ${prev ? `<div style="font-size:11px;margin-top:5px;color:${score >= prev.ai_score ? 'var(--score-excellent)' : 'var(--danger)'};">${score >= prev.ai_score ? '‚ñ≤ ‡∏î‡∏µ‡∏Ç‡∏∂‡πâ‡∏ô' : '‚ñº ‡∏•‡∏î‡∏•‡∏á'} ${Math.abs(score - prev.ai_score)} ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô ‡∏à‡∏≤‡∏Å‡∏õ‡∏µ‡∏Å‡πà‡∏≠‡∏ô</div>` : ''}
        </div>
      </div>
    </div>
  </div>

  <div class="grid-2">
    <div class="card">
      <div class="card-title">üìä ‡∏Å‡∏£‡∏≤‡∏ü‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏±‡∏ô‡πÇ‡∏•‡∏´‡∏¥‡∏ï & ‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡∏•</div>
      <div class="chart-wrap"><canvas id="chart-bp-fbs"></canvas></div>
    </div>
    <div class="card">
      <div class="card-title">üíõ ‡∏Å‡∏£‡∏≤‡∏ü‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏°‡πÑ‡∏Ç‡∏°‡∏±‡∏ô‡πÉ‡∏ô‡πÄ‡∏•‡∏∑‡∏≠‡∏î</div>
      <div class="chart-wrap"><canvas id="chart-lipid"></canvas></div>
    </div>
  </div>

  <div class="card" style="margin-bottom:20px;">
    <div class="card-title">üî¨ ‡∏Ñ‡πà‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏≠‡∏∑‡πà‡∏ô‡πÜ ‚Äî ‡∏õ‡∏µ ${selectedYear}</div>
    <table class="tbl">
      <thead><tr><th>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th><th>‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏ß‡∏à‡πÑ‡∏î‡πâ</th><th>‡∏Ñ‡πà‡∏≤‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á (‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô‡πÑ‡∏ó‡∏¢)</th><th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th></tr></thead>
      <tbody>
        <tr><td>AST (SGOT)</td><td>${d.sgot ? d.sgot+' U/L' : '‚Äî'}</td><td>‚â§ 40 U/L</td><td>${liverStatus(d.sgot, d.sgpt)}</td></tr>
        <tr><td>ALT (SGPT)</td><td>${d.sgpt ? d.sgpt+' U/L' : '‚Äî'}</td><td>‚â§ 40 U/L</td><td></td></tr>
        <tr><td>Creatinine</td><td>${d.creatinine ? d.creatinine+' mg/dL' : '‚Äî'}</td><td>0.7-1.2 mg/dL</td><td>${creatinineStatus(d.creatinine)}</td></tr>
        <tr><td>Hemoglobin</td><td>${d.hemoglobin ? d.hemoglobin+' g/dL' : '‚Äî'}</td><td>‡∏ä‡∏≤‡∏¢ 13.5-17.5 / ‡∏´‡∏ç‡∏¥‡∏á 12-16</td><td>${hbStatus(d.hemoglobin)}</td></tr>
        <tr><td>HDL</td><td>${d.hdl ? d.hdl+' mg/dL' : '‚Äî'}</td><td>‡∏ä‡∏≤‡∏¢ ‚â•40 / ‡∏´‡∏ç‡∏¥‡∏á ‚â•50</td><td>${hdlStatus(d.hdl)}</td></tr>
        <tr><td>LDL</td><td>${d.ldl ? d.ldl+' mg/dL' : '‚Äî'}</td><td>< 130 mg/dL (‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ)</td><td>${ldlStatus(d.ldl)}</td></tr>
        <tr><td>Triglyceride</td><td>${d.triglyceride ? d.triglyceride+' mg/dL' : '‚Äî'}</td><td>< 150 mg/dL</td><td>${tgStatus(d.triglyceride)}</td></tr>
        <tr><td>EKG</td><td>${d.ekg_result||'‚Äî'}</td><td>Normal Sinus Rhythm</td><td>${d.ekg_result ? (d.ekg_result.includes('‡∏õ‡∏Å‡∏ï‡∏¥') ? '<span class="badge b-ok">‡∏õ‡∏Å‡∏ï‡∏¥</span>' : '<span class="badge b-warn">‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥</span>') : '<span class="badge b-gray">‚Äî</span>'}</td></tr>
        <tr><td>X-Ray ‡∏õ‡∏≠‡∏î</td><td>${d.xray_result||'‚Äî'}</td><td>Normal</td><td>${d.xray_result ? (d.xray_result.includes('‡∏õ‡∏Å‡∏ï‡∏¥') ? '<span class="badge b-ok">‡∏õ‡∏Å‡∏ï‡∏¥</span>' : '<span class="badge b-warn">‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥</span>') : '<span class="badge b-gray">‚Äî</span>'}</td></tr>
        <tr><td>‡∏õ‡∏±‡∏™‡∏™‡∏≤‡∏ß‡∏∞</td><td>${d.urine_result||'‚Äî'}</td><td>‡∏õ‡∏Å‡∏ï‡∏¥</td><td>${d.urine_result ? (d.urine_result==='‡∏õ‡∏Å‡∏ï‡∏¥' ? '<span class="badge b-ok">‡∏õ‡∏Å‡∏ï‡∏¥</span>' : '<span class="badge b-warn">‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥</span>') : '<span class="badge b-gray">‚Äî</span>'}</td></tr>
      </tbody>
    </table>
  </div>

  ${d.ai_summary ? `
  <div class="ai-box">
    <div class="ai-head"><div class="ai-dot"></div><span class="ai-title">ü§ñ ‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô ‡∏õ‡∏µ ${selectedYear}</span><button class="btn-gold" style="margin-left:auto;padding:6px 14px;font-size:12px;" onclick="runAI()">üîÑ ‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡πÉ‡∏´‡∏°‡πà</button></div>
    <div style="font-size:11px;color:rgba(255,255,255,.45);margin-bottom:10px;font-style:italic;">‚ö†Ô∏è ‡∏ú‡∏•‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏û‡∏ó‡∏¢‡πå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏õ‡∏£‡∏∂‡∏Å‡∏©‡∏≤‡πÅ‡∏û‡∏ó‡∏¢‡πå‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡∏ô‡∏¥‡∏à‡∏â‡∏±‡∏¢‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á</div>
    <div class="ai-text">${d.ai_summary.replace(/\n/g,'<br>')}</div>
  </div>` : `
  <div class="ai-box">
    <div class="ai-head"><div class="ai-dot"></div><span class="ai-title">ü§ñ ‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô</span><button class="btn-gold" style="margin-left:auto;padding:6px 14px;font-size:12px;" onclick="runAI()">‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡πÄ‡∏•‡∏¢</button></div>
    <div style="font-size:11px;color:rgba(255,255,255,.45);margin-bottom:8px;font-style:italic;">‚ö†Ô∏è ‡∏ú‡∏•‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏û‡∏ó‡∏¢‡πå</div>
    <div class="ai-text" style="opacity:.65;">‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ AI ‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô‡∏à‡∏≤‡∏Å‡∏ú‡∏•‡∏ï‡∏£‡∏ß‡∏à‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</div>
  </div>`}
  `;

  setTimeout(() => {
    drawScoreChart();
    drawBPFBSChart();
    drawLipidChart();
  }, 100);
}

function drawScoreChart() {
  const ctx = document.getElementById('chart-score');
  if (!ctx) return;
  if (dashCharts['score']) dashCharts['score'].destroy();

  const sorted = [...annualData].sort((a,b) => a.checkup_year - b.checkup_year);
  const labels = sorted.map(r => '‡∏õ‡∏µ ' + r.checkup_year);
  const scores = sorted.map(r => r.ai_score || calcScore(r));

  let forecast = null;
  if (scores.length >= 2) {
    const n = scores.length;
    const last = scores[n-1], prev2 = scores[n-2];
    forecast = Math.max(0, Math.min(100, Math.round(last + (last - prev2) * 0.7)));
    labels.push('‡∏õ‡∏µ ' + (sorted[sorted.length-1].checkup_year + 1) + ' (‡∏û‡∏¢‡∏≤‡∏Å‡∏£‡∏ì‡πå)');
    scores.push(null);
  }

  dashCharts['score'] = new Chart(ctx, {
    type: 'line',
    data: {
      labels,
      datasets: [
        {
          label: '‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡∏à‡∏£‡∏¥‡∏á',
          data: [...scores.slice(0, sorted.length)],
          borderColor: '#6B21A8', backgroundColor: 'rgba(107,33,168,.1)',
          borderWidth: 3, pointRadius: 6, pointBackgroundColor: '#6B21A8',
          fill: true, tension: 0.4
        },
        ...(forecast !== null ? [{
          label: '‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏°‡∏û‡∏¢‡∏≤‡∏Å‡∏£‡∏ì‡πå',
          data: [...Array(sorted.length - 1).fill(null), scores[sorted.length-1], forecast],
          borderColor: '#B8860B', borderDash: [6, 4],
          borderWidth: 2, pointRadius: [0,0,0,7], pointBackgroundColor: '#B8860B',
          fill: false, tension: 0.4
        }] : [])
      ]
    },
    options: {
      responsive: true, maintainAspectRatio: false,
      plugins: { legend: { labels: { font: { family: 'Sarabun', size: 12 } } } },
      scales: {
        y: { min: 0, max: 100, ticks: { font: { family: 'Sarabun' } }, grid: { color: '#F3F4F6' } },
        x: { ticks: { font: { family: 'Sarabun', size: 11 } } }
      }
    }
  });
}

function drawBPFBSChart() {
  const ctx = document.getElementById('chart-bp-fbs');
  if (!ctx) return;
  if (dashCharts['bpfbs']) dashCharts['bpfbs'].destroy();
  const sorted = [...annualData].sort((a,b) => a.checkup_year - b.checkup_year);
  dashCharts['bpfbs'] = new Chart(ctx, {
    type: 'line',
    data: {
      labels: sorted.map(r => r.checkup_year),
      datasets: [
        { label: '‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏±‡∏ô (mmHg)', data: sorted.map(r => r.bp_systolic), borderColor: '#DC2626', backgroundColor: 'rgba(220,38,38,.05)', borderWidth: 2, tension: 0.4, yAxisID: 'y1' },
        { label: '‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡∏• FBS (mg/dL)', data: sorted.map(r => r.fbs), borderColor: '#D97706', backgroundColor: 'rgba(217,119,6,.05)', borderWidth: 2, tension: 0.4, yAxisID: 'y2' },
      ]
    },
    options: {
      responsive: true, maintainAspectRatio: false,
      plugins: { legend: { labels: { font: { family: 'Sarabun', size: 11 } } } },
      scales: {
        y1: { position:'left', ticks: { font:{family:'Sarabun'} }, grid:{color:'#F3F4F6'} },
        y2: { position:'right', ticks: { font:{family:'Sarabun'} }, grid:{display:false} },
        x: { ticks: { font:{family:'Sarabun',size:11} } }
      }
    }
  });
}

function drawLipidChart() {
  const ctx = document.getElementById('chart-lipid');
  if (!ctx) return;
  if (dashCharts['lipid']) dashCharts['lipid'].destroy();
  const sorted = [...annualData].sort((a,b) => a.checkup_year - b.checkup_year);
  dashCharts['lipid'] = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: sorted.map(r => r.checkup_year),
      datasets: [
        { label: 'Total Chol', data: sorted.map(r => r.total_cholesterol), backgroundColor: 'rgba(107,33,168,.6)', borderRadius: 5 },
        { label: 'TG', data: sorted.map(r => r.triglyceride), backgroundColor: 'rgba(184,134,11,.6)', borderRadius: 5 },
        { label: 'HDL', data: sorted.map(r => r.hdl), backgroundColor: 'rgba(5,150,105,.6)', borderRadius: 5 },
        { label: 'LDL', data: sorted.map(r => r.ldl), backgroundColor: 'rgba(220,38,38,.5)', borderRadius: 5 },
      ]
    },
    options: {
      responsive: true, maintainAspectRatio: false,
      plugins: { legend: { labels: { font:{family:'Sarabun',size:11} } } },
      scales: {
        y: { ticks:{font:{family:'Sarabun'}}, grid:{color:'#F3F4F6'} },
        x: { ticks:{font:{family:'Sarabun',size:11}} }
      }
    }
  });
}

// ===== RESULTS PAGE =====
async function loadResults() {
  if (!annualData.length) await loadDashboard();
  if (!annualData.length) return;
  const ytabs = document.getElementById('res-ytabs');
  ytabs.innerHTML = annualData.map((r, i) => `<div class="ytab ${i===0?'active':''}" onclick="renderResultTable(${r.checkup_year},this)">${r.checkup_year}</div>`).join('');
  renderResultTable(annualData[0].checkup_year, null);
}

function renderResultTable(year, el) {
  if (el) { document.querySelectorAll('#res-ytabs .ytab').forEach(t => t.classList.remove('active')); el.classList.add('active'); }
  const d = annualData.find(r => r.checkup_year === year);
  if (!d) return;
  const rows = [
    ['‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å', d.weight, '‡∏Å‡∏Å.', '‚Äî', '<span class="badge b-gray">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</span>'],
    ['‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏π‡∏á', d.height, '‡∏ã‡∏°.', '‚Äî', '<span class="badge b-gray">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</span>'],
    ['‡∏£‡∏≠‡∏ö‡πÄ‡∏≠‡∏ß', d.waist_circumference, '‡∏ã‡∏°.', '‡∏ä‡∏≤‡∏¢<90 / ‡∏´‡∏ç‡∏¥‡∏á<80', waistStatus(d.waist_circumference)],
    ['BMI', d.bmi, '', '18.5‚Äì22.9 (‡πÄ‡∏≠‡πÄ‡∏ä‡∏µ‡∏¢)', bmiStatus(d.bmi)],
    ['‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ö‡∏ô', d.bp_systolic, 'mmHg', '< 120', bpStatus(d.bp_systolic)],
    ['‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏•‡πà‡∏≤‡∏á', d.bp_diastolic, 'mmHg', '< 80', d.bp_diastolic ? (d.bp_diastolic < 80 ? '<span class="badge b-ok">‡∏õ‡∏Å‡∏ï‡∏¥</span>' : '<span class="badge b-warn">‡∏™‡∏π‡∏á</span>') : '<span class="badge b-gray">‚Äî</span>'],
    ['‡∏ä‡∏µ‡∏û‡∏à‡∏£', d.pulse, '‡∏Ñ‡∏£‡∏±‡πâ‡∏á/‡∏ô‡∏≤‡∏ó‡∏µ', '60‚Äì100', d.pulse ? (d.pulse>=60&&d.pulse<=100?'<span class="badge b-ok">‡∏õ‡∏Å‡∏ï‡∏¥</span>':'<span class="badge b-warn">‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥</span>') : '<span class="badge b-gray">‚Äî</span>'],
    ['Hemoglobin', d.hemoglobin, 'g/dL', '‡∏ä‡∏≤‡∏¢ 13.5-17.5', hbStatus(d.hemoglobin)],
    ['WBC', d.wbc, 'cells/ŒºL', '4,500-11,000', d.wbc ? (d.wbc>=4500&&d.wbc<=11000?'<span class="badge b-ok">‡∏õ‡∏Å‡∏ï‡∏¥</span>':'<span class="badge b-warn">‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥</span>') : '<span class="badge b-gray">‚Äî</span>'],
    ['FBS ‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡∏•', d.fbs, 'mg/dL', '70-99 mg/dL (ADA 2023)', fbsStatus(d.fbs)],
    ['HbA1c', d.hba1c, '%', '< 5.7%', d.hba1c ? (d.hba1c<5.7?'<span class="badge b-ok">‡∏õ‡∏Å‡∏ï‡∏¥</span>':d.hba1c<6.5?'<span class="badge b-warn">‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á</span>':'<span class="badge b-danger">‡πÄ‡∏ö‡∏≤‡∏´‡∏ß‡∏≤‡∏ô</span>') : '<span class="badge b-gray">‚Äî</span>'],
    ['Total Cholesterol', d.total_cholesterol, 'mg/dL', '< 200 mg/dL', cholStatus(d.total_cholesterol)],
    ['HDL', d.hdl, 'mg/dL', '‡∏ä‡∏≤‡∏¢‚â•40 / ‡∏´‡∏ç‡∏¥‡∏á‚â•50', hdlStatus(d.hdl)],
    ['LDL', d.ldl, 'mg/dL', '< 130 mg/dL', ldlStatus(d.ldl)],
    ['Triglyceride', d.triglyceride, 'mg/dL', '< 150 mg/dL', tgStatus(d.triglyceride)],
    ['AST (SGOT)', d.sgot, 'U/L', '‚â§ 40 U/L', d.sgot ? (d.sgot<=40?'<span class="badge b-ok">‡∏õ‡∏Å‡∏ï‡∏¥</span>':'<span class="badge b-warn">‡∏™‡∏π‡∏á</span>') : '<span class="badge b-gray">‚Äî</span>'],
    ['ALT (SGPT)', d.sgpt, 'U/L', '‚â§ 40 U/L', d.sgpt ? (d.sgpt<=40?'<span class="badge b-ok">‡∏õ‡∏Å‡∏ï‡∏¥</span>':'<span class="badge b-warn">‡∏™‡∏π‡∏á</span>') : '<span class="badge b-gray">‚Äî</span>'],
    ['GGT', d.ggt, 'U/L', '‡∏ä‡∏≤‡∏¢ ‚â§55 / ‡∏´‡∏ç‡∏¥‡∏á ‚â§38', d.ggt ? (d.ggt<=55?'<span class="badge b-ok">‡∏õ‡∏Å‡∏ï‡∏¥</span>':'<span class="badge b-warn">‡∏™‡∏π‡∏á</span>') : '<span class="badge b-gray">‚Äî</span>'],
    ['Creatinine', d.creatinine, 'mg/dL', '0.7-1.2 mg/dL', creatinineStatus(d.creatinine)],
    ['Uric Acid', d.uric_acid, 'mg/dL', '‡∏ä‡∏≤‡∏¢ 3.5-7.2 / ‡∏´‡∏ç‡∏¥‡∏á 2.6-6.0', d.uric_acid ? (d.uric_acid<=7.2?'<span class="badge b-ok">‡∏õ‡∏Å‡∏ï‡∏¥</span>':'<span class="badge b-warn">‡∏™‡∏π‡∏á</span>') : '<span class="badge b-gray">‚Äî</span>'],
    ['EKG', d.ekg_result, '', 'Normal Sinus Rhythm', d.ekg_result ? (d.ekg_result.includes('‡∏õ‡∏Å‡∏ï‡∏¥')?'<span class="badge b-ok">‡∏õ‡∏Å‡∏ï‡∏¥</span>':'<span class="badge b-warn">‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥</span>') : '<span class="badge b-gray">‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏£‡∏ß‡∏à</span>'],
    ['X-Ray ‡∏õ‡∏≠‡∏î', d.xray_result, '', 'Normal', d.xray_result ? (d.xray_result.includes('‡∏õ‡∏Å‡∏ï‡∏¥')?'<span class="badge b-ok">‡∏õ‡∏Å‡∏ï‡∏¥</span>':'<span class="badge b-warn">‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥</span>') : '<span class="badge b-gray">‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏£‡∏ß‡∏à</span>'],
    ['‡∏õ‡∏±‡∏™‡∏™‡∏≤‡∏ß‡∏∞', d.urine_result, '', '‡∏õ‡∏Å‡∏ï‡∏¥', d.urine_result ? (d.urine_result==='‡∏õ‡∏Å‡∏ï‡∏¥'?'<span class="badge b-ok">‡∏õ‡∏Å‡∏ï‡∏¥</span>':'<span class="badge b-warn">‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥</span>') : '<span class="badge b-gray">‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏£‡∏ß‡∏à</span>'],
  ];
  document.getElementById('res-content').innerHTML = `
  <div class="card">
    <div class="card-title" style="justify-content:space-between;">üìã ‡∏ú‡∏•‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡∏õ‡∏µ ${year} ‚Äî ${dateTH(d.checkup_date)} ¬∑ ${d.hospital||''} <button class="btn-xs btn-edit" onclick="editAnnual(${JSON.stringify(d).replace(/"/g,'&quot;')})">‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏µ‡πâ</button></div>
    <table class="tbl"><thead><tr><th>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à</th><th>‡∏ú‡∏•‡∏ï‡∏£‡∏ß‡∏à</th><th>‡∏Ñ‡πà‡∏≤‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á (‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô‡πÑ‡∏ó‡∏¢)</th><th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th></tr></thead>
    <tbody>${rows.map(r => `<tr><td>${r[0]}</td><td>${r[1]!=null&&r[1]!==undefined&&r[1]!=='' ? r[1]+' '+r[2] : '<span class="badge b-gray">‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏£‡∏ß‡∏à</span>'}</td><td style="font-size:12px;color:var(--sub)">${r[3]}</td><td>${r[4]}</td></tr>`).join('')}
    </tbody></table>
  </div>`;
}

// ===== AI PAGE =====
async function loadAIPage() {
  if (!annualData.length) await loadDashboard();
  const el = document.getElementById('ai-content');
  if (!annualData.length) { el.innerHTML = '<div class="empty"><div class="empty-ico">ü§ñ</div><h3>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h3></div>'; return; }
  const d = annualData[0];
  el.innerHTML = `
  <div class="ai-box">
    <div class="ai-head"><div class="ai-dot"></div><span class="ai-title">ü§ñ ‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô ‚Äî ‡∏õ‡∏µ ${d.checkup_year}</span>
    <button class="btn-gold" style="margin-left:auto;padding:6px 14px;font-size:12px;" onclick="runAI()">üîÑ ‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡πÉ‡∏´‡∏°‡πà</button></div>
    <div style="font-size:11px;color:rgba(255,255,255,.45);margin-bottom:10px;font-style:italic;">‚ö†Ô∏è ‡∏ú‡∏•‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏û‡∏ó‡∏¢‡πå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏õ‡∏£‡∏∂‡∏Å‡∏©‡∏≤‡πÅ‡∏û‡∏ó‡∏¢‡πå‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡∏ô‡∏¥‡∏à‡∏â‡∏±‡∏¢‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á</div>
    <div class="ai-text" id="ai-result-text">${d.ai_summary ? d.ai_summary.replace(/\n/g,'<br>') : '<span style="opacity:.65">‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ AI ‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô‡∏à‡∏≤‡∏Å‡∏ú‡∏•‡∏ï‡∏£‡∏ß‡∏à‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</span>'}</div>
  </div>
  <div class="card">
    <div class="card-title">üìÖ ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û</div>
    <table class="tbl"><thead><tr><th>‡∏õ‡∏µ</th><th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏ß‡∏à</th><th>‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û</th><th>‡∏£‡∏∞‡∏î‡∏±‡∏ö</th></tr></thead>
    <tbody>${annualData.map(r => { const sc=r.ai_score||calcScore(r); const {label,color}=scoreLabel(sc); return `<tr><td>${r.checkup_year}</td><td>${dateTH(r.checkup_date)}</td><td><span style="font-family:'Prompt';font-weight:700;font-size:18px;color:${color}">${sc}</span>/100</td><td><span class="badge" style="background:${color}20;color:${color}">${label}</span></td></tr>`; }).join('')}</tbody>
    </table>
  </div>`;
}

async function runAI() {
  const aiKey = localStorage.getItem('ai_key');
  const d = annualData.find(r => r.checkup_year === selectedYear) || annualData[0];
  if (!d) return;
  const textEl = document.getElementById('ai-result-text');
  if (textEl) textEl.innerHTML = '<span class="spinner"></span> AI ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô...';

  const THAI_STANDARDS = `‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á‡∏™‡∏≤‡∏ò‡∏≤‡∏£‡∏ì‡∏™‡∏∏‡∏Ç‡πÑ‡∏ó‡∏¢:
- BMI: <18.5=‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏ô‡πâ‡∏≠‡∏¢, 18.5-22.9=‡∏õ‡∏Å‡∏ï‡∏¥ (‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡πÄ‡∏≠‡πÄ‡∏ä‡∏µ‡∏¢-‡πÅ‡∏õ‡∏ã‡∏¥‡∏ü‡∏¥‡∏Å), 23-24.9=‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡πÄ‡∏Å‡∏¥‡∏ô, ‚â•25=‡∏≠‡πâ‡∏ß‡∏ô
- ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏±‡∏ô: <120/80=‡∏õ‡∏Å‡∏ï‡∏¥, 120-129/<80=elevated, 130-139/80-89=HT stage1, ‚â•140/90=HT stage2 (ACC/AHA 2017)
- FBS: <100=‡∏õ‡∏Å‡∏ï‡∏¥, 100-125=Prediabetes, ‚â•126=‡∏™‡∏á‡∏™‡∏±‡∏¢‡πÄ‡∏ö‡∏≤‡∏´‡∏ß‡∏≤‡∏ô (ADA 2023)
- ‡∏Ñ‡∏≠‡πÄ‡∏•‡∏™‡πÄ‡∏ï‡∏≠‡∏£‡∏≠‡∏•: <200=‡∏õ‡∏Å‡∏ï‡∏¥, 200-239=borderline, ‚â•240=‡∏™‡∏π‡∏á (NCEP ATP III)
- AST/ALT: ‚â§40 U/L (ULN ‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ)
- Creatinine: 0.7-1.2 mg/dL
- ‡∏£‡∏≠‡∏ö‡πÄ‡∏≠‡∏ß: ‡∏ä‡∏≤‡∏¢<90‡∏ã‡∏°., ‡∏´‡∏ç‡∏¥‡∏á<80‡∏ã‡∏°. (‡∏Å‡∏£‡∏°‡∏≠‡∏ô‡∏≤‡∏°‡∏±‡∏¢)`;

  const prompt = `${THAI_STANDARDS}

‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏õ‡πá‡∏ô‡πÅ‡∏û‡∏ó‡∏¢‡πå‡πÄ‡∏ß‡∏ä‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏ú‡∏•‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏õ‡∏µ‡∏Ç‡∏≠‡∏á‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô ‡πÅ‡∏•‡∏∞‡πÉ‡∏´‡πâ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡∏á‡πà‡∏≤‡∏¢:

‡∏ú‡∏•‡∏ï‡∏£‡∏ß‡∏à ‡∏õ‡∏µ ${d.checkup_year}:
- ‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å: ${d.weight}‡∏Å‡∏Å., ‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏π‡∏á: ${d.height}‡∏ã‡∏°., BMI: ${d.bmi}, ‡∏£‡∏≠‡∏ö‡πÄ‡∏≠‡∏ß: ${d.waist_circumference||'‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏£‡∏ß‡∏à'}‡∏ã‡∏°.
- ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏±‡∏ô: ${d.bp_systolic}/${d.bp_diastolic} mmHg
- FBS: ${d.fbs||'‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏£‡∏ß‡∏à'} mg/dL, HbA1c: ${d.hba1c||'‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏£‡∏ß‡∏à'}%
- Total Chol: ${d.total_cholesterol||'‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏£‡∏ß‡∏à'}, HDL: ${d.hdl||'‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏£‡∏ß‡∏à'}, LDL: ${d.ldl||'‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏£‡∏ß‡∏à'}, TG: ${d.triglyceride||'‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏£‡∏ß‡∏à'} mg/dL
- AST: ${d.sgot||'‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏£‡∏ß‡∏à'}, ALT: ${d.sgpt||'‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏£‡∏ß‡∏à'} U/L
- Creatinine: ${d.creatinine||'‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏£‡∏ß‡∏à'} mg/dL, Uric Acid: ${d.uric_acid||'‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏£‡∏ß‡∏à'}
- Hemoglobin: ${d.hemoglobin||'‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏£‡∏ß‡∏à'} g/dL
- EKG: ${d.ekg_result||'‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏£‡∏ß‡∏à'}
- X-Ray: ${d.xray_result||'‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏£‡∏ß‡∏à'}
- ‡∏õ‡∏±‡∏™‡∏™‡∏≤‡∏ß‡∏∞: ${d.urine_result||'‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏£‡∏ß‡∏à'}

‡∏Å‡∏£‡∏∏‡∏ì‡∏≤:
1. ü©∫ ‡∏™‡∏£‡∏∏‡∏õ‡∏†‡∏≤‡∏ß‡∏∞‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡πÇ‡∏î‡∏¢‡∏£‡∏ß‡∏° (‡πÉ‡∏ä‡πâ emoji)
2. ‚ö†Ô∏è ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥ + ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏°‡∏≤‡∏¢‡∏ó‡∏≤‡∏á‡∏Ñ‡∏•‡∏¥‡∏ô‡∏¥‡∏Å (‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á‡∏Ñ‡πà‡∏≤‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô‡πÑ‡∏ó‡∏¢)
3. ‚úÖ ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏õ‡∏Å‡∏ï‡∏¥‡∏ô‡πà‡∏≤‡∏ä‡∏∑‡πà‡∏ô‡∏ä‡∏°
4. üíä ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡πÑ‡∏î‡πâ‡∏à‡∏£‡∏¥‡∏á ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç
5. üìÖ ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Å‡∏≤‡∏£‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏ú‡∏•‡∏ó‡∏µ‡πà‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥`;

  try {
    if (!aiKey) throw new Error('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Anthropic API Key ‡πÉ‡∏ô‡πÅ‡∏ñ‡∏ö‡∏™‡∏µ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô');
    const res = await fetch('https://api.anthropic.com/v1/messages', {
      method: 'POST',
      headers: { 'Content-Type':'application/json', 'x-api-key':aiKey, 'anthropic-version':'2023-06-01' },
      body: JSON.stringify({ model:'claude-haiku-4-5-20251001', max_tokens:1000, messages:[{role:'user',content:prompt}] })
    });
    const json = await res.json();
    const summary = json.content?.[0]?.text || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡πÑ‡∏î‡πâ';
    const score = calcScore(d);
    await sb.from('annual_checkup').update({ ai_summary: summary, ai_score: score }).eq('id', d.id);
    const idx = annualData.findIndex(r => r.checkup_year === d.checkup_year);
    if (idx >= 0) { annualData[idx].ai_summary = summary; annualData[idx].ai_score = score; }
    if (textEl) textEl.innerHTML = summary.replace(/\n/g,'<br>');
    showNotif('ü§ñ AI ‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß!', 'success');
  } catch(e) {
    if (textEl) textEl.innerHTML = `<span style="color:#FCA5A5">‚ùå ${e.message}</span>`;
  }
}

// ===== SAVE ANNUAL =====
async function saveAnnual() {
  const btn = document.getElementById('btn-save-annual');
  btn.disabled = true; btn.textContent = '‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...';
  const w = parseFloat(document.getElementById('f-weight').value);
  const h = parseFloat(document.getElementById('f-height').value);
  const payload = {
    emp_id: currentUser.emp_id,
    checkup_year: parseInt(document.getElementById('f-year').value),
    checkup_date: document.getElementById('f-date').value || null,
    hospital: document.getElementById('f-hospital').value || null,
    weight: w || null, height: h || null,
    bmi: (w && h) ? parseFloat((w/((h/100)**2)).toFixed(2)) : null,
    waist_circumference: parseFloat(document.getElementById('f-waist').value)||null,
    bp_systolic: parseInt(document.getElementById('f-bps').value)||null,
    bp_diastolic: parseInt(document.getElementById('f-bpd').value)||null,
    pulse: parseInt(document.getElementById('f-pulse').value)||null,
    hemoglobin: parseFloat(document.getElementById('f-hb').value)||null,
    hematocrit: parseFloat(document.getElementById('f-hct').value)||null,
    wbc: parseFloat(document.getElementById('f-wbc').value)||null,
    platelet: parseInt(document.getElementById('f-plt').value)||null,
    fbs: parseFloat(document.getElementById('f-fbs').value)||null,
    hba1c: parseFloat(document.getElementById('f-hba1c').value)||null,
    total_cholesterol: parseFloat(document.getElementById('f-chol').value)||null,
    hdl: parseFloat(document.getElementById('f-hdl').value)||null,
    ldl: parseFloat(document.getElementById('f-ldl').value)||null,
    triglyceride: parseFloat(document.getElementById('f-tg').value)||null,
    sgot: parseFloat(document.getElementById('f-sgot').value)||null,
    sgpt: parseFloat(document.getElementById('f-sgpt').value)||null,
    ggt: parseFloat(document.getElementById('f-ggt').value)||null,
    alp: parseFloat(document.getElementById('f-alp').value)||null,
    creatinine: parseFloat(document.getElementById('f-cr').value)||null,
    bun: parseFloat(document.getElementById('f-bun').value)||null,
    uric_acid: parseFloat(document.getElementById('f-ua').value)||null,
    urine_result: document.getElementById('f-urine').value || null,
    urine_note: document.getElementById('f-urine-note').value || null,
    ekg_result: document.getElementById('f-ekg').value || null,
    xray_result: document.getElementById('f-xray').value || null,
    xray_note: document.getElementById('f-xray-note').value || null,
    vision_right: document.getElementById('f-vr').value || null,
    vision_left: document.getElementById('f-vl').value || null,
  };
  try {
    let error;
    if (editingAnnualId) {
      ({ error } = await sb.from('annual_checkup').update(payload).eq('id', editingAnnualId));
      editingAnnualId = null;
    } else {
      ({ error } = await sb.from('annual_checkup').upsert(payload, { onConflict: 'emp_id,checkup_year' }));
    }
    if (error) throw error;
    showNotif('‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!', 'success');
    annualData = [];
    const btn2 = document.getElementById('btn-save-annual');
    if (btn2) btn2.textContent = 'üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•';
    clearAnnualForm();
    goto('dashboard');
  } catch(e) { showNotif('‚ùå ' + e.message, 'error'); }
  btn.disabled = false; btn.textContent = 'üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•';
}

function clearAnnualForm() {
  document.querySelectorAll('#page-enter-annual .fi').forEach(el => { el.value = ''; el.disabled = false; });
  document.querySelectorAll('#page-enter-annual input[type=checkbox]').forEach(el => el.checked = false);
}

// ===== SAVE RISK =====
async function saveRisk() {
  const btn = document.getElementById('btn-save-risk');
  btn.disabled = true; btn.textContent = '‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...';
  const payload = {
    emp_id: currentUser.emp_id,
    checkup_year: parseInt(document.getElementById('rf-year').value),
    checkup_date: document.getElementById('rf-date').value||null,
    hospital: document.getElementById('rf-hospital').value||null,
    doctor: document.getElementById('rf-doctor').value||null,
    hearing_right: parseInt(document.getElementById('rf-hr').value)||null,
    hearing_left: parseInt(document.getElementById('rf-hl').value)||null,
    hearing_result: document.getElementById('rf-hres').value,
    fvc: parseFloat(document.getElementById('rf-fvc').value)||null,
    fev1: parseFloat(document.getElementById('rf-fev1').value)||null,
    lung_result: document.getElementById('rf-lres').value,
    chemical_test: document.getElementById('rf-chem').value||null,
    chemical_result: document.getElementById('rf-cres').value||null,
    chemical_unit: document.getElementById('rf-cunit').value||null,
    chemical_reference: document.getElementById('rf-cref').value||null,
    ekg_risk_result: document.getElementById('rf-ekg').value,
    creatinine_risk: parseFloat(document.getElementById('rf-cr').value)||null,
    bmi_risk: parseFloat(document.getElementById('rf-bmi').value)||null,
    overall_result: document.getElementById('rf-overall').value,
    notes: document.getElementById('rf-notes').value||null,
  };
  try {
    let error;
    if (editingRiskId) {
      ({ error } = await sb.from('risk_checkup').update(payload).eq('id', editingRiskId));
    } else {
      ({ error } = await sb.from('risk_checkup').insert(payload));
    }
    if (error) throw error;
    showNotif(editingRiskId ? '‚úÖ ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!' : '‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!', 'success');
    editingRiskId = null;
    document.getElementById('btn-save-risk').textContent = 'üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•';
    riskData = [];
    clearRiskForm();
    goto('my-risk');
  } catch(e) { showNotif('‚ùå ' + e.message, 'error'); }
  btn.disabled = false; btn.textContent = editingRiskId ? 'üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç' : 'üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•';
}

function clearRiskForm() {
  document.querySelectorAll('#page-enter-risk .fi').forEach(el => { if (el.tagName !== 'SELECT') el.value = ''; el.disabled = false; });
  document.querySelectorAll('#page-enter-risk input[type=checkbox]').forEach(el => el.checked = false);
}

// ===== MY RISK =====
async function loadMyRisk() {
  const el = document.getElementById('my-risk-content');
  el.innerHTML = '<div class="loading"><span class="spinner"></span>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>';
  const { data } = await sb.from('risk_checkup').select('*').eq('emp_id', currentUser.emp_id).order('checkup_year', { ascending: false });
  riskData = data || [];
  if (!riskData.length) { el.innerHTML = '<div class="empty"><div class="empty-ico">‚ö†Ô∏è</div><h3>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h3><button class="btn-primary" style="margin-top:12px" onclick="goto(\'enter-risk\')">‚úèÔ∏è ‡∏•‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏•‡∏¢</button></div>'; return; }
  el.innerHTML = `<div class="card"><div class="card-title" style="justify-content:space-between;">‚ö†Ô∏è ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ï‡∏£‡∏ß‡∏à‡∏õ‡∏±‡∏à‡∏à‡∏±‡∏¢‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á <button class="btn-primary" style="padding:6px 14px;font-size:12px;" onclick="goto('enter-risk')">+ ‡∏•‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà</button></div>
  <div style="overflow-x:auto;"><table class="emp-table"><thead><tr><th>‡∏õ‡∏µ</th><th>‡∏Å‡∏≤‡∏£‡πÑ‡∏î‡πâ‡∏¢‡∏¥‡∏ô</th><th>‡∏õ‡∏≠‡∏î FVC</th><th>‡∏™‡∏≤‡∏£‡πÄ‡∏Ñ‡∏°‡∏µ</th><th>EKG</th><th>‡∏ú‡∏•‡∏£‡∏ß‡∏°</th><th>‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</th></tr></thead>
  <tbody>${riskData.map(r=>`<tr>
    <td><strong>${r.checkup_year}</strong><br><span style="font-size:11px;color:var(--sub)">${r.checkup_date||''}</span></td>
    <td>${r.hearing_result||'‚Äî'}<br><span style="font-size:11px;color:var(--sub)">${r.hearing_right||''}${r.hearing_right?'/':''} ${r.hearing_left||''} ${r.hearing_right||r.hearing_left?'dB':''}</span></td>
    <td>${r.fvc||'‚Äî'}${r.fvc?'%':''}<br><span style="font-size:11px;color:var(--sub)">${r.lung_result||'‚Äî'}</span></td>
    <td style="font-size:12px">${r.chemical_test||'‚Äî'}</td>
    <td><span class="badge ${r.ekg_risk_result==='‡∏õ‡∏Å‡∏ï‡∏¥'?'b-ok':r.ekg_risk_result&&r.ekg_risk_result!=='‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏£‡∏ß‡∏à'?'b-warn':'b-gray'}">${r.ekg_risk_result||'‚Äî'}</span></td>
    <td><span class="badge ${r.overall_result==='‡∏õ‡∏Å‡∏ï‡∏¥'?'b-ok':'b-warn'}">${r.overall_result||'‚Äî'}</span></td>
    <td><button class="btn-xs btn-edit" onclick="editRisk('${r.id}')">‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button></td>
  </tr>`).join('')}</tbody></table></div></div>`;
}

function editRisk(id) {
  const r = riskData.find(x => x.id === id);
  if (!r) return;
  editingRiskId = id;
  goto('enter-risk');
  setTimeout(() => {
    const set = (id, val) => { const el = document.getElementById(id); if (el) el.value = val || ''; };
    set('rf-year', r.checkup_year); set('rf-date', r.checkup_date); set('rf-hospital', r.hospital);
    set('rf-doctor', r.doctor); set('rf-hr', r.hearing_right); set('rf-hl', r.hearing_left);
    set('rf-fvc', r.fvc); set('rf-fev1', r.fev1); set('rf-chem', r.chemical_test);
    set('rf-cres', r.chemical_result); set('rf-cunit', r.chemical_unit); set('rf-cref', r.chemical_reference);
    set('rf-cr', r.creatinine_risk); set('rf-bmi', r.bmi_risk); set('rf-notes', r.notes);
    const setSelect = (id, val) => { const el = document.getElementById(id); if (el && val) el.value = val; };
    setSelect('rf-hres', r.hearing_result); setSelect('rf-lres', r.lung_result);
    setSelect('rf-ekg', r.ekg_risk_result); setSelect('rf-overall', r.overall_result);
    document.getElementById('btn-save-risk').textContent = 'üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç';
    showNotif('üìù ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏°‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢ ‚Äî ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å', 'success');
  }, 150);
}

// ===== RISK DASHBOARD =====
async function loadRiskDash() {
  const el = document.getElementById('risk-dash-content');
  el.innerHTML = '<div class="loading"><span class="spinner"></span>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>';
  try {
    if (!riskData.length) {
      const { data } = await sb.from('risk_checkup').select('*').eq('emp_id', currentUser.emp_id).order('checkup_year', { ascending: false });
      riskData = data || [];
    }
    if (!riskData.length) { el.innerHTML = `<div class="empty"><div class="empty-ico">‚ö†Ô∏è</div><h3>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏±‡∏à‡∏à‡∏±‡∏¢‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á</h3><button class="btn-primary" style="margin-top:12px" onclick="goto('enter-risk')">‚úèÔ∏è ‡∏•‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏•‡∏¢</button></div>`; return; }
    const years = [...new Set(riskData.map(r => r.checkup_year))].sort((a,b) => b-a);
    if (!window.selectedRiskYear || !years.includes(window.selectedRiskYear)) window.selectedRiskYear = years[0];
    const ytabsEl = document.getElementById('risk-dash-ytabs');
    ytabsEl.innerHTML = years.map(y => `<div class="ytab ${y===window.selectedRiskYear?'active':''}" onclick="window.selectedRiskYear=${y};loadRiskDash()">${y}</div>`).join('');
    const d = riskData.find(r => r.checkup_year === window.selectedRiskYear);
    const hearBadge = v => !v||v==='‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏£‡∏ß‡∏à'?'<span class="badge b-gray">‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏£‡∏ß‡∏à</span>':v==='‡∏õ‡∏Å‡∏ï‡∏¥'?'<span class="badge b-ok">‡∏õ‡∏Å‡∏ï‡∏¥</span>':v.includes('‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢')?'<span class="badge b-warn">‡∏™‡∏π‡∏ç‡πÄ‡∏™‡∏µ‡∏¢‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢</span>':'<span class="badge b-danger">‡∏™‡∏π‡∏ç‡πÄ‡∏™‡∏µ‡∏¢‡∏°‡∏≤‡∏Å</span>';
    const lungBadge = v => !v||v==='‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏£‡∏ß‡∏à'?'<span class="badge b-gray">‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏£‡∏ß‡∏à</span>':v==='‡∏õ‡∏Å‡∏ï‡∏¥'?'<span class="badge b-ok">‡∏õ‡∏Å‡∏ï‡∏¥</span>':`<span class="badge b-warn">${v}</span>`;
    const fvcBadge = v => !v?'<span class="badge b-gray">‚Äî</span>':v>=80?'<span class="badge b-ok">‡∏õ‡∏Å‡∏ï‡∏¥ (‚â•80%)</span>':v>=60?'<span class="badge b-warn">‡∏•‡∏î‡∏•‡∏á‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á</span>':'<span class="badge b-danger">‡∏•‡∏î‡∏•‡∏á‡∏°‡∏≤‡∏Å</span>';
    const ekgBadge = v => !v||v==='‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏£‡∏ß‡∏à'?'<span class="badge b-gray">‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏£‡∏ß‡∏à</span>':v==='‡∏õ‡∏Å‡∏ï‡∏¥'?'<span class="badge b-ok">‡∏õ‡∏Å‡∏ï‡∏¥</span>':'<span class="badge b-warn">‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥</span>';
    el.innerHTML = `
    <div class="risk-stat-grid">
      <div class="risk-stat-card"><div class="risk-stat-ico">üëÇ</div><div class="risk-stat-lbl">‡∏Å‡∏≤‡∏£‡πÑ‡∏î‡πâ‡∏¢‡∏¥‡∏ô</div><div class="risk-stat-val">${d.hearing_right||'‚Äî'}/${d.hearing_left||'‚Äî'} <span style="font-size:12px;font-weight:400;color:var(--sub)">dB</span></div>${hearBadge(d.hearing_result)}</div>
      <div class="risk-stat-card"><div class="risk-stat-ico">ü´Å</div><div class="risk-stat-lbl">‡∏™‡∏°‡∏£‡∏£‡∏ñ‡∏†‡∏≤‡∏û‡∏õ‡∏≠‡∏î FVC</div><div class="risk-stat-val">${d.fvc||'‚Äî'}<span style="font-size:12px;font-weight:400;color:var(--sub)">%</span></div>${fvcBadge(d.fvc)}</div>
      <div class="risk-stat-card"><div class="risk-stat-ico">‚ù§Ô∏è</div><div class="risk-stat-lbl">EKG</div><div class="risk-stat-val" style="font-size:14px">${d.ekg_risk_result||'‚Äî'}</div>${ekgBadge(d.ekg_risk_result)}</div>
      <div class="risk-stat-card"><div class="risk-stat-ico">üìä</div><div class="risk-stat-lbl">‡∏ú‡∏•‡∏£‡∏ß‡∏°</div><div class="risk-stat-val" style="font-size:15px">${d.overall_result||'‚Äî'}</div><span class="badge ${d.overall_result==='‡∏õ‡∏Å‡∏ï‡∏¥'?'b-ok':'b-warn'}">${d.overall_result||'‚Äî'}</span></div>
    </div>
    <div class="grid-2">
      <div class="card"><div class="card-title">üëÇ ‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏°‡∏Å‡∏≤‡∏£‡πÑ‡∏î‡πâ‡∏¢‡∏¥‡∏ô (dB HL)</div><div class="chart-wrap-sm"><canvas id="chart-hearing"></canvas></div></div>
      <div class="card"><div class="card-title">ü´Å ‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏°‡∏™‡∏°‡∏£‡∏£‡∏ñ‡∏†‡∏≤‡∏û‡∏õ‡∏≠‡∏î (%)</div><div class="chart-wrap-sm"><canvas id="chart-lung"></canvas></div></div>
    </div>
    <div class="card">
      <div class="card-title" style="justify-content:space-between;">üî¨ ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ú‡∏•‡∏ï‡∏£‡∏ß‡∏à ‡∏õ‡∏µ ${window.selectedRiskYear} <button class="btn-xs btn-edit" onclick="editRisk('${d.id}')">‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏µ‡πâ</button></div>
      <table class="tbl"><thead><tr><th>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th><th>‡∏ú‡∏•‡∏ï‡∏£‡∏ß‡∏à</th><th>‡∏Ñ‡πà‡∏≤‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á</th><th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th></tr></thead><tbody>
        <tr><td>üëÇ ‡∏´‡∏π‡∏Ç‡∏ß‡∏≤</td><td>${d.hearing_right||'‚Äî'} dB</td><td>&lt;25 dB HL</td><td>${d.hearing_right?d.hearing_right<25?'<span class="badge b-ok">‡∏õ‡∏Å‡∏ï‡∏¥</span>':d.hearing_right<40?'<span class="badge b-warn">‡∏™‡∏π‡∏ç‡πÄ‡∏™‡∏µ‡∏¢‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢</span>':'<span class="badge b-danger">‡∏™‡∏π‡∏ç‡πÄ‡∏™‡∏µ‡∏¢‡∏°‡∏≤‡∏Å</span>':'<span class="badge b-gray">‚Äî</span>'}</td></tr>
        <tr><td>üëÇ ‡∏´‡∏π‡∏ã‡πâ‡∏≤‡∏¢</td><td>${d.hearing_left||'‚Äî'} dB</td><td>&lt;25 dB HL</td><td>${d.hearing_left?d.hearing_left<25?'<span class="badge b-ok">‡∏õ‡∏Å‡∏ï‡∏¥</span>':d.hearing_left<40?'<span class="badge b-warn">‡∏™‡∏π‡∏ç‡πÄ‡∏™‡∏µ‡∏¢‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢</span>':'<span class="badge b-danger">‡∏™‡∏π‡∏ç‡πÄ‡∏™‡∏µ‡∏¢‡∏°‡∏≤‡∏Å</span>':'<span class="badge b-gray">‚Äî</span>'}</td></tr>
        <tr><td>ü´Å FVC</td><td>${d.fvc||'‚Äî'}${d.fvc?'%':''}</td><td>‚â•80% predicted</td><td>${fvcBadge(d.fvc)}</td></tr>
        <tr><td>ü´Å FEV1</td><td>${d.fev1||'‚Äî'}${d.fev1?'%':''}</td><td>‚â•70%</td><td>${d.fev1?d.fev1>=70?'<span class="badge b-ok">‡∏õ‡∏Å‡∏ï‡∏¥</span>':'<span class="badge b-warn">‡∏•‡∏î‡∏•‡∏á</span>':'<span class="badge b-gray">‚Äî</span>'}</td></tr>
        <tr><td>ü´Å ‡∏ú‡∏•‡∏õ‡∏≠‡∏î</td><td colspan="2">${d.lung_result||'‚Äî'}</td><td>${lungBadge(d.lung_result)}</td></tr>
        <tr><td>‚öóÔ∏è ‡∏™‡∏≤‡∏£‡πÄ‡∏Ñ‡∏°‡∏µ</td><td>${d.chemical_test||'‚Äî'}: ${d.chemical_result||'‚Äî'} ${d.chemical_unit||''}</td><td>${d.chemical_reference||'‚Äî'}</td><td><span class="badge b-info">‡∏î‡∏π‡∏ú‡∏•</span></td></tr>
        <tr><td>‚ù§Ô∏è EKG</td><td>${d.ekg_risk_result||'‚Äî'}</td><td>Normal Sinus Rhythm</td><td>${ekgBadge(d.ekg_risk_result)}</td></tr>
        <tr><td>ü´ò Creatinine</td><td>${d.creatinine_risk||'‚Äî'}${d.creatinine_risk?' mg/dL':''}</td><td>0.7-1.2 mg/dL</td><td>${d.creatinine_risk?d.creatinine_risk<=1.2?'<span class="badge b-ok">‡∏õ‡∏Å‡∏ï‡∏¥</span>':'<span class="badge b-warn">‡∏™‡∏π‡∏á</span>':'<span class="badge b-gray">‚Äî</span>'}</td></tr>
      </tbody></table>
      ${d.notes?`<div style="margin-top:12px;padding:10px 14px;background:var(--bg);border-radius:8px;font-size:13px;color:var(--sub);">üìù ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: ${d.notes}</div>`:''}
    </div>`;
    setTimeout(() => {
      const sorted = [...riskData].sort((a,b)=>a.checkup_year-b.checkup_year);
      const mkChart = (id, key, datasets, opts={}) => {
        const ctx = document.getElementById(id); if (!ctx) return;
        if (dashCharts[id]) dashCharts[id].destroy();
        dashCharts[id] = new Chart(ctx, { type:'line', data:{ labels:sorted.map(r=>'‡∏õ‡∏µ '+r.checkup_year), datasets }, options:{ responsive:true, maintainAspectRatio:false, plugins:{ legend:{ labels:{ font:{ family:'Sarabun', size:11 }}}}, scales:{ y:{ ticks:{ font:{ family:'Sarabun' }}, grid:{ color:'#F3F4F6' }, ...opts }, x:{ ticks:{ font:{ family:'Sarabun', size:11 }}}}}});
      };
      mkChart('chart-hearing', null, [
        {label:'‡∏´‡∏π‡∏Ç‡∏ß‡∏≤ (dB)',data:sorted.map(r=>r.hearing_right),borderColor:'#6B21A8',borderWidth:2,tension:.4,pointRadius:5,pointBackgroundColor:'#6B21A8'},
        {label:'‡∏´‡∏π‡∏ã‡πâ‡∏≤‡∏¢ (dB)',data:sorted.map(r=>r.hearing_left),borderColor:'#D97706',borderWidth:2,tension:.4,pointRadius:5,pointBackgroundColor:'#D97706'},
      ]);
      mkChart('chart-lung', null, [
        {label:'FVC (%)',data:sorted.map(r=>r.fvc),borderColor:'#059669',borderWidth:2,tension:.4,fill:true,backgroundColor:'rgba(5,150,105,.07)',pointRadius:5,pointBackgroundColor:'#059669'},
        {label:'FEV1 (%)',data:sorted.map(r=>r.fev1),borderColor:'#1D4ED8',borderWidth:2,tension:.4,pointRadius:5,pointBackgroundColor:'#1D4ED8'},
      ], {min:50,max:110});
    }, 100);
  } catch(e) { document.getElementById('risk-dash-content').innerHTML = `<div class="empty"><div class="empty-ico">‚ö†Ô∏è</div><h3>${e.message}</h3></div>`; }
}

// ===== EDIT ANNUAL =====
function editAnnual(d) {
  editingAnnualId = d.id;
  goto('enter-annual');
  setTimeout(() => {
    const set = (id, val) => { const el = document.getElementById(id); if (el) el.value = val||''; };
    set('f-year',d.checkup_year); set('f-date',d.checkup_date); set('f-hospital',d.hospital);
    set('f-weight',d.weight); set('f-height',d.height); set('f-bmi',d.bmi); set('f-waist',d.waist_circumference);
    set('f-bps',d.bp_systolic); set('f-bpd',d.bp_diastolic); set('f-pulse',d.pulse);
    set('f-hb',d.hemoglobin); set('f-hct',d.hematocrit); set('f-wbc',d.wbc); set('f-plt',d.platelet);
    set('f-fbs',d.fbs); set('f-hba1c',d.hba1c); set('f-chol',d.total_cholesterol);
    set('f-hdl',d.hdl); set('f-ldl',d.ldl); set('f-tg',d.triglyceride);
    set('f-sgot',d.sgot); set('f-sgpt',d.sgpt); set('f-ggt',d.ggt); set('f-alp',d.alp);
    set('f-cr',d.creatinine); set('f-bun',d.bun); set('f-ua',d.uric_acid);
    set('f-urine-note',d.urine_note); set('f-xray-note',d.xray_note);
    set('f-vr',d.vision_right); set('f-vl',d.vision_left);
    const setS = (id, val) => { const el = document.getElementById(id); if (el && val) el.value = val; };
    setS('f-urine',d.urine_result); setS('f-ekg',d.ekg_result); setS('f-xray',d.xray_result);
    const btn = document.getElementById('btn-save-annual');
    if (btn) btn.textContent = 'üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç';
    showNotif('üìù ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏°‡πÅ‡∏•‡πâ‡∏ß ‚Äî ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å', 'success');
  }, 150);
}

// ===== MODAL =====
function openModal(title, html) {
  document.getElementById('modal-content').innerHTML = `<div class="modal-title">${title}</div>${html}`;
  document.getElementById('modal-bg').style.display = 'flex';
}
function closeModal() { document.getElementById('modal-bg').style.display = 'none'; }

// ===== ADMIN =====
let adminTab = 'emp', allEmployees = [];
function switchAdminTab(tab) {
  adminTab = tab;
  document.querySelectorAll('.admin-tab').forEach(t => t.classList.remove('active'));
  document.getElementById('atab-' + tab).classList.add('active');
  loadAdmin();
}

async function loadAdmin() {
  if (currentUser.role !== 'admin') return;
  const el = document.getElementById('admin-content');
  el.innerHTML = '<div class="loading"><span class="spinner"></span>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>';

  if (adminTab === 'emp') {
    const { data } = await sb.from('employees').select('*').order('emp_id');
    allEmployees = data || [];
    el.innerHTML = `
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:14px;">
      <div style="font-size:13px;color:var(--sub);">‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î <strong>${allEmployees.length} ‡∏Ñ‡∏ô</strong></div>
      <button class="btn-primary" onclick="openAddEmpModal()">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</button>
    </div>
    <div style="overflow-x:auto;"><table class="emp-table">
      <thead><tr><th>‡∏£‡∏´‡∏±‡∏™</th><th>‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</th><th>‡πÅ‡∏ú‡∏ô‡∏Å</th><th>‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó</th><th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th></tr></thead>
      <tbody>${allEmployees.map(e=>`<tr>
        <td><span class="badge b-purple">${e.emp_id}</span></td>
        <td>${e.full_name}</td>
        <td style="font-size:12px">${e.department||'‚Äî'}</td>
        <td><span class="badge ${e.role==='admin'?'b-danger':'b-ok'}">${e.role==='admin'?'üëë Admin':'‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô'}</span></td>
        <td style="display:flex;gap:5px;flex-wrap:wrap;">
          <button class="btn-xs btn-edit" onclick="openEditEmpModal('${e.emp_id}')">‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
          <button class="btn-xs btn-reset" onclick="resetPassword('${e.emp_id}','${e.full_name.replace(/'/g,"\\'")}')">üîë ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï</button>
        </td>
      </tr>`).join('')}</tbody>
    </table></div>`;

  } else if (adminTab === 'annual') {
    const { data } = await sb.from('annual_checkup').select('id,emp_id,checkup_year,bmi,bp_systolic,bp_diastolic,fbs,total_cholesterol,hdl,ldl,triglyceride,sgot,sgpt,creatinine,ekg_result,ai_score,employees(full_name,department)').order('checkup_year',{ascending:false});
    el.innerHTML = `<div style="overflow-x:auto;"><table class="emp-table">
      <thead><tr><th>‡∏ä‡∏∑‡πà‡∏≠</th><th>‡πÅ‡∏ú‡∏ô‡∏Å</th><th>‡∏õ‡∏µ</th><th>BMI</th><th>‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏±‡∏ô</th><th>FBS</th><th>Chol</th><th>‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</th><th>‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</th></tr></thead>
      <tbody>${(data||[]).map(r=>`<tr>
        <td>${r.employees?.full_name||r.emp_id}</td>
        <td style="font-size:12px">${r.employees?.department||'‚Äî'}</td>
        <td>${r.checkup_year}</td>
        <td>${r.bmi||'‚Äî'}</td><td>${r.bp_systolic||'‚Äî'}/${r.bp_diastolic||'‚Äî'}</td>
        <td>${r.fbs||'‚Äî'}</td><td>${r.total_cholesterol||'‚Äî'}</td>
        <td><span style="font-weight:700;color:${(r.ai_score||0)>=75?'#16A34A':'#D97706'}">${r.ai_score||'‚Äî'}</span></td>
        <td><button class="btn-xs btn-edit" onclick="adminEditAnnual('${r.id}')">‚úèÔ∏è</button></td>
      </tr>`).join('')}</tbody></table></div>`;

  } else if (adminTab === 'risk') {
    const { data } = await sb.from('risk_checkup').select('*,employees(full_name,department)').order('checkup_year',{ascending:false});
    el.innerHTML = `<div style="overflow-x:auto;"><table class="emp-table">
      <thead><tr><th>‡∏ä‡∏∑‡πà‡∏≠</th><th>‡πÅ‡∏ú‡∏ô‡∏Å</th><th>‡∏õ‡∏µ</th><th>‡∏Å‡∏≤‡∏£‡πÑ‡∏î‡πâ‡∏¢‡∏¥‡∏ô</th><th>‡∏õ‡∏≠‡∏î FVC</th><th>EKG</th><th>‡∏ú‡∏•‡∏£‡∏ß‡∏°</th></tr></thead>
      <tbody>${(data||[]).map(r=>`<tr>
        <td>${r.employees?.full_name||r.emp_id}</td>
        <td style="font-size:12px">${r.employees?.department||'‚Äî'}</td>
        <td>${r.checkup_year}</td>
        <td>${r.hearing_result||'‚Äî'}</td>
        <td>${r.fvc||'‚Äî'}${r.fvc?'%':''}</td>
        <td style="font-size:12px">${r.ekg_risk_result||'‚Äî'}</td>
        <td><span class="badge ${r.overall_result==='‡∏õ‡∏Å‡∏ï‡∏¥'?'b-ok':'b-warn'}">${r.overall_result||'‚Äî'}</span></td>
      </tr>`).join('')}</tbody></table></div>`;

  } else if (adminTab === 'export') {
    el.innerHTML = `<div class="grid-2">
      <div class="card" style="text-align:center;padding:28px;">
        <div style="font-size:44px;margin-bottom:12px;">üìä</div>
        <div style="font-family:'Prompt',sans-serif;font-weight:700;font-size:15px;margin-bottom:6px;">‡∏ú‡∏•‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏õ‡∏µ</div>
        <div style="font-size:12px;color:var(--sub);margin-bottom:16px;">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÄ‡∏õ‡πá‡∏ô CSV ‡∏û‡∏£‡πâ‡∏≠‡∏° Excel</div>
        <button class="btn-primary" style="width:100%;" onclick="exportCSV('annual')">üì• Download CSV</button>
      </div>
      <div class="card" style="text-align:center;padding:28px;">
        <div style="font-size:44px;margin-bottom:12px;">‚ö†Ô∏è</div>
        <div style="font-family:'Prompt',sans-serif;font-weight:700;font-size:15px;margin-bottom:6px;">‡∏ú‡∏•‡∏ï‡∏£‡∏ß‡∏à‡∏õ‡∏±‡∏à‡∏à‡∏±‡∏¢‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á</div>
        <div style="font-size:12px;color:var(--sub);margin-bottom:16px;">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÄ‡∏õ‡πá‡∏ô CSV</div>
        <button class="btn-primary" style="width:100%;" onclick="exportCSV('risk')">üì• Download CSV</button>
      </div>
      <div class="card" style="text-align:center;padding:28px;grid-column:1/-1;">
        <div style="font-size:44px;margin-bottom:12px;">üìÑ</div>
        <div style="font-family:'Prompt',sans-serif;font-weight:700;font-size:15px;margin-bottom:6px;">‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏£‡∏∏‡∏õ‡∏≠‡∏á‡∏Ñ‡πå‡∏Å‡∏£ (HTML)</div>
        <div style="font-size:12px;color:var(--sub);margin-bottom:16px;">‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ú‡∏π‡πâ‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£‡πÅ‡∏•‡∏∞‡∏™‡πà‡∏á‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô</div>
        <button class="btn-gold" style="padding:10px 28px;" onclick="exportSummaryReport()">üìã ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</button>
      </div>
    </div>`;

  } else if (adminTab === 'passwd') {
    if (!allEmployees.length) { const { data } = await sb.from('employees').select('emp_id,full_name').order('emp_id'); allEmployees = data||[]; }
    el.innerHTML = `
    <div class="grid-2">
      <div class="card">
        <div class="card-title">üîë ‡∏Ñ‡∏π‡πà‡∏°‡∏∑‡∏≠‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</div>
        ${[['1Ô∏è‚É£','‡πÄ‡∏õ‡∏¥‡∏î Supabase Dashboard','supabase.com ‚Üí ‡πÄ‡∏Ç‡πâ‡∏≤ Project'],['2Ô∏è‚É£','‡πÑ‡∏õ‡∏ó‡∏µ‡πà Table Editor','‡πÄ‡∏°‡∏ô‡∏π‡∏ã‡πâ‡∏≤‡∏¢ ‚Üí Table Editor'],['3Ô∏è‚É£','‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏≤‡∏£‡∏≤‡∏á employees','‡∏Ñ‡∏•‡∏¥‡∏Å employees'],['4Ô∏è‚É£','‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô','Filter ‡∏î‡πâ‡∏ß‡∏¢ emp_id'],['5Ô∏è‚É£','‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç password_hash','‡∏Ñ‡∏•‡∏¥‡∏Å Edit ‚Üí ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏£‡∏´‡∏±‡∏™‡πÉ‡∏´‡∏°‡πà'],['6Ô∏è‚É£','‡∏Å‡∏î Save','‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÉ‡∏ä‡πâ‡∏£‡∏´‡∏±‡∏™‡πÉ‡∏´‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ']].map(([n,t,d])=>`
          <div style="display:flex;gap:12px;margin-bottom:12px;padding:12px;background:var(--bg);border-radius:9px;">
            <div style="font-size:20px">${n}</div><div><div style="font-weight:700;font-size:13px;">${t}</div><div style="font-size:12px;color:var(--sub);margin-top:2px">${d}</div></div>
          </div>`).join('')}
      </div>
      <div class="card">
        <div class="card-title">‚ö° ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏î‡πà‡∏ß‡∏ô‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</div>
        <div class="fg" style="margin-bottom:12px;"><label class="fl">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</label>
          <select class="fi" id="reset-emp-sel">
            <option value="">‚Äî ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô ‚Äî</option>
            ${allEmployees.map(e=>`<option value="${e.emp_id}">${e.emp_id} ‚Äî ${e.full_name}</option>`).join('')}
          </select>
        </div>
        <div class="fg" style="margin-bottom:16px;"><label class="fl">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà</label>
          <input class="fi" type="text" id="reset-new-pw" placeholder="‡∏ï‡∏±‡πâ‡∏á‡∏£‡∏´‡∏±‡∏™‡πÉ‡∏´‡∏°‡πà">
        </div>
        <button class="btn-gold" style="width:100%;" onclick="quickResetPass()">üîë ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</button>
        <div class="alert-warn" style="margin-top:14px;font-size:12px;">‚ö†Ô∏è ‡πÅ‡∏à‡πâ‡∏á‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏´‡∏•‡∏±‡∏á‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏£‡∏´‡∏±‡∏™‡πÉ‡∏´‡∏°‡πà</div>
      </div>
    </div>`;
  }
}

function openAddEmpModal() {
  const depts = ['‡πÅ‡∏ú‡∏ô‡∏Å‡∏Å‡πà‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á','‡πÅ‡∏ú‡∏ô‡∏Å‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£','‡πÅ‡∏ú‡∏ô‡∏Å‡∏°‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå','‡πÅ‡∏ú‡∏ô‡∏Å‡∏Ñ‡∏•‡∏±‡∏á‡∏û‡∏±‡∏™‡∏î‡∏∏','‡πÅ‡∏ú‡∏ô‡∏Å‡∏ö‡∏±‡∏ç‡∏ä‡∏µ','‡πÅ‡∏ú‡∏ô‡∏Å‡∏™‡∏ô‡∏±‡∏ö‡∏™‡∏ô‡∏∏‡∏ô','‡πÅ‡∏ú‡∏ô‡∏Å‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤'];
  openModal('üë§ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà', `
    <div class="grid-form">
      <div class="fg"><label class="fl">‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</label><input class="fi" type="text" id="m-empid" placeholder="EMP007"></div>
      <div class="fg"><label class="fl">‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</label><input class="fi" type="text" id="m-name" placeholder="‡∏ô‡∏≤‡∏¢‡∏™‡∏°‡∏ä‡∏≤‡∏¢ ‡∏î‡∏µ‡∏°‡∏≤‡∏Å"></div>
      <div class="fg"><label class="fl">‡πÅ‡∏ú‡∏ô‡∏Å</label><select class="fi" id="m-dept">${depts.map(d=>`<option>${d}</option>`).join('')}</select></div>
      <div class="fg"><label class="fl">‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó</label><select class="fi" id="m-role"><option value="employee">‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</option><option value="admin">Admin</option></select></div>
      <div class="fg"><label class="fl">‡πÄ‡∏û‡∏®</label><select class="fi" id="m-gender"><option value="male">‡∏ä‡∏≤‡∏¢</option><option value="female">‡∏´‡∏ç‡∏¥‡∏á</option></select></div>
      <div class="fg"><label class="fl">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô</label><input class="fi" type="text" id="m-pass" value="1234"></div>
    </div>
    <div class="btn-row"><button class="btn-primary" onclick="saveNewEmp()">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button><button class="btn-sec" onclick="closeModal()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button></div>`);
}

async function saveNewEmp() {
  const payload = { emp_id: document.getElementById('m-empid').value.trim().toUpperCase(), full_name: document.getElementById('m-name').value.trim(), department: document.getElementById('m-dept').value, role: document.getElementById('m-role').value, gender: document.getElementById('m-gender').value, password_hash: document.getElementById('m-pass').value };
  if (!payload.emp_id || !payload.full_name) { showNotif('‚ùó ‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡πÅ‡∏•‡∏∞‡∏ä‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö','error'); return; }
  const { error } = await sb.from('employees').insert(payload);
  if (error) { showNotif('‚ùå ' + error.message,'error'); return; }
  showNotif('‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢','success'); closeModal(); loadAdmin();
}

function openEditEmpModal(empId) {
  const e = allEmployees.find(x => x.emp_id === empId); if (!e) return;
  const depts = ['‡πÅ‡∏ú‡∏ô‡∏Å‡∏Å‡πà‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á','‡πÅ‡∏ú‡∏ô‡∏Å‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£','‡πÅ‡∏ú‡∏ô‡∏Å‡∏°‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå','‡πÅ‡∏ú‡∏ô‡∏Å‡∏Ñ‡∏•‡∏±‡∏á‡∏û‡∏±‡∏™‡∏î‡∏∏','‡πÅ‡∏ú‡∏ô‡∏Å‡∏ö‡∏±‡∏ç‡∏ä‡∏µ','‡πÅ‡∏ú‡∏ô‡∏Å‡∏™‡∏ô‡∏±‡∏ö‡∏™‡∏ô‡∏∏‡∏ô','‡πÅ‡∏ú‡∏ô‡∏Å‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤'];
  openModal('‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô', `
    <div class="grid-form">
      <div class="fg"><label class="fl">‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</label><input class="fi" value="${e.emp_id}" disabled></div>
      <div class="fg"><label class="fl">‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</label><input class="fi" type="text" id="me-name" value="${e.full_name}"></div>
      <div class="fg"><label class="fl">‡πÅ‡∏ú‡∏ô‡∏Å</label><select class="fi" id="me-dept">${depts.map(d=>`<option ${d===e.department?'selected':''}>${d}</option>`).join('')}</select></div>
      <div class="fg"><label class="fl">‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó</label><select class="fi" id="me-role"><option value="employee" ${e.role==='employee'?'selected':''}>‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</option><option value="admin" ${e.role==='admin'?'selected':''}>Admin</option></select></div>
    </div>
    <div class="btn-row"><button class="btn-primary" onclick="saveEditEmp('${e.emp_id}')">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button><button class="btn-sec" onclick="closeModal()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button></div>`);
}

async function saveEditEmp(empId) {
  const payload = { full_name: document.getElementById('me-name').value.trim(), department: document.getElementById('me-dept').value, role: document.getElementById('me-role').value };
  const { error } = await sb.from('employees').update(payload).eq('emp_id', empId);
  if (error) { showNotif('‚ùå '+error.message,'error'); return; }
  showNotif('‚úÖ ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢','success'); closeModal(); loadAdmin();
}

function resetPassword(empId, name) {
  openModal('üîë ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô', `
    <p style="margin-bottom:16px;font-size:14px;">‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á <strong>${name}</strong> (${empId})</p>
    <div class="fg" style="margin-bottom:16px;"><label class="fl">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà</label><input class="fi" type="text" id="rp-pass" value="1234"></div>
    <div class="btn-row"><button class="btn-gold" onclick="doResetPass('${empId}')">üîë ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï</button><button class="btn-sec" onclick="closeModal()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button></div>`);
}

async function doResetPass(empId) {
  const newPass = document.getElementById('rp-pass').value;
  if (!newPass) { showNotif('‚ùó ‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà','error'); return; }
  const { error } = await sb.from('employees').update({ password_hash: newPass }).eq('emp_id', empId);
  if (error) { showNotif('‚ùå '+error.message,'error'); return; }
  showNotif(`‚úÖ ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï ${empId} ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢ ‚Äî ‡∏£‡∏´‡∏±‡∏™‡πÉ‡∏´‡∏°‡πà: ${newPass}`,'success'); closeModal();
}

async function quickResetPass() {
  const empId = document.getElementById('reset-emp-sel').value;
  const newPass = document.getElementById('reset-new-pw').value;
  if (!empId||!newPass) { showNotif('‚ùó ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡∏∞‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡πÉ‡∏´‡∏°‡πà','error'); return; }
  const { error } = await sb.from('employees').update({ password_hash: newPass }).eq('emp_id', empId);
  if (error) { showNotif('‚ùå '+error.message,'error'); return; }
  showNotif(`‚úÖ ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï ${empId} ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!`,'success');
  document.getElementById('reset-new-pw').value = '';
}

async function exportCSV(type) {
  const table = type==='annual'?'annual_checkup':'risk_checkup';
  const { data } = await sb.from(table).select('*,employees(full_name,department)').order('checkup_year',{ascending:false});
  if (!data?.length) { showNotif('‚ùå ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•','error'); return; }
  const skip = new Set(['employees']);
  const keys = Object.keys(data[0]).filter(k=>!skip.has(k));
  const rows = [['‡∏ä‡∏∑‡πà‡∏≠','‡πÅ‡∏ú‡∏ô‡∏Å',...keys], ...data.map(r=>[r.employees?.full_name||r.emp_id, r.employees?.department||'‚Äî', ...keys.map(k=>r[k]??'')])];
  const csv = rows.map(r=>r.map(v=>`"${String(v).replace(/"/g,'""')}"`).join(',')).join('\n');
  const a = document.createElement('a');
  a.href = URL.createObjectURL(new Blob(['\uFEFF'+csv],{type:'text/csv;charset=utf-8;'}));
  a.download = `PEA_Pattani_${type}_${new Date().getFullYear()}.csv`; a.click();
  showNotif('üì• ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î CSV ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!','success');
}

async function exportSummaryReport() {
  const { data: annual } = await sb.from('annual_checkup').select('*,employees(full_name,department)').order('checkup_year',{ascending:false});
  const n = annual?.length||0;
  const html = `<!DOCTYPE html><html lang="th"><head><meta charset="UTF-8"><title>‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û PEA Pattani</title><style>body{font-family:sans-serif;padding:30px;color:#111;}h1{color:#3B0764;}h2{color:#6B21A8;}table{width:100%;border-collapse:collapse;margin-top:20px;font-size:13px;}th{background:#6B21A8;color:white;padding:9px 12px;text-align:left;}td{padding:8px 12px;border:1px solid #ddd;}tr:nth-child(even) td{background:#F5F3FF;}.sum{display:inline-block;margin:6px 12px 6px 0;padding:8px 16px;border-radius:8px;background:#EDE9FE;font-weight:bold;}</style></head><body>

  <h1>‚ö° ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ú‡∏•‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û</h1><h2>‡∏Å‡∏≤‡∏£‡πÑ‡∏ü‡∏ü‡πâ‡∏≤‡∏™‡πà‡∏ß‡∏ô‡∏†‡∏π‡∏°‡∏¥‡∏†‡∏≤‡∏Ñ ‡∏™‡∏≤‡∏Ç‡∏≤‡∏õ‡∏±‡∏ï‡∏ï‡∏≤‡∏ô‡∏µ</h2>
  <p>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏û‡∏¥‡∏°‡∏û‡πå: ${new Date().toLocaleDateString('th-TH',{year:'numeric',month:'long',day:'numeric'})} | ‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ï‡∏£‡∏ß‡∏à: <strong>${n} ‡∏Ñ‡∏ô</strong></p>
  <div><span class="sum">BMI‚â•23: ${(annual||[]).filter(r=>r.bmi>=23).length} ‡∏Ñ‡∏ô</span><span class="sum">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏±‡∏ô‚â•130: ${(annual||[]).filter(r=>r.bp_systolic>=130).length} ‡∏Ñ‡∏ô</span><span class="sum">FBS‚â•100: ${(annual||[]).filter(r=>r.fbs>=100).length} ‡∏Ñ‡∏ô</span><span class="sum">Chol‚â•200: ${(annual||[]).filter(r=>r.total_cholesterol>=200).length} ‡∏Ñ‡∏ô</span></div>
  <table><thead><tr><th>‡∏ä‡∏∑‡πà‡∏≠</th><th>‡πÅ‡∏ú‡∏ô‡∏Å</th><th>‡∏õ‡∏µ</th><th>BMI</th><th>‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏±‡∏ô</th><th>FBS</th><th>‡∏Ñ‡∏≠‡πÄ‡∏•‡∏™‡πÄ‡∏ï‡∏≠‡∏£‡∏≠‡∏•</th><th>AST/ALT</th><th>‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</th></tr></thead>
  <tbody>${(annual||[]).map(r=>`<tr><td>${r.employees?.full_name||r.emp_id}</td><td>${r.employees?.department||'‚Äî'}</td><td>${r.checkup_year}</td><td>${r.bmi||'‚Äî'}</td><td>${r.bp_systolic||'‚Äî'}/${r.bp_diastolic||'‚Äî'}</td><td>${r.fbs||'‚Äî'}</td><td>${r.total_cholesterol||'‚Äî'}</td><td>${r.sgot||'‚Äî'}/${r.sgpt||'‚Äî'}</td><td>${r.ai_score||'‚Äî'}</td></tr>`).join('')}
  </tbody></table></body></html>`;
  const a = document.createElement('a');
  a.href = URL.createObjectURL(new Blob([html],{type:'text/html;charset=utf-8;'}));
  a.download = 'PEA_Pattani_HealthReport.html'; a.click();
  showNotif('üìÑ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô HTML ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!','success');
}

async function adminEditAnnual(id) {
const { data, error } = await sb.from(‚Äòannual_checkup‚Äô).select(‚Äô*‚Äô).eq(‚Äòid‚Äô, id).single();
if (error||!data) { showNotif(‚Äò‚ùå ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‚Äô,‚Äòerror‚Äô); return; }
annualData = [data];
editAnnual(data);
}

// ===== ORG HEALTH =====
async function loadOrgHealth() {
const el = document.getElementById(‚Äòorg-health-content‚Äô);
el.innerHTML = ‚Äò<div class="loading"><span class="spinner"></span>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‚Ä¶</div>‚Äô;
try {
const [annualRes, empRes] = await Promise.all([
sb.from(‚Äòannual_checkup‚Äô).select(‚Äòbmi,bp_systolic,fbs,total_cholesterol,hdl,triglyceride,sgot,sgpt,creatinine,ekg_result,xray_result,checkup_year‚Äô).eq(‚Äòcheckup_year‚Äô, new Date().getFullYear()+543-1),
sb.from(‚Äòemployees‚Äô).select(‚Äòid‚Äô).eq(‚Äòrole‚Äô,‚Äòemployee‚Äô),
]);
const annual = annualRes.data||[], total = empRes.data?.length||142, n = annual.length;
if (!n) { el.innerHTML=‚Äô<div class="empty"><div class="empty-ico">üìä</div><h3>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏•‡∏ï‡∏£‡∏ß‡∏à‡∏õ‡∏µ‡∏ô‡∏µ‡πâ</h3></div>‚Äô; return; }
const pct = c => n>0?Math.round(c/n*100):0;
const stats = [
{icon:‚Äò‚öñÔ∏è‚Äô,label:‚Äò‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡πÄ‡∏Å‡∏¥‡∏ô (BMI‚â•23)‚Äô,n:annual.filter(r=>r.bmi>=23).length},
{icon:‚Äòü©∏‚Äô,label:‚Äò‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏±‡∏ô‡∏™‡∏π‡∏á (‚â•130)‚Äô,n:annual.filter(r=>r.bp_systolic>=130).length},
{icon:‚Äòüç¨‚Äô,label:‚Äò‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡∏•‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á (FBS‚â•100)‚Äô,n:annual.filter(r=>r.fbs>=100).length},
{icon:‚Äòüíõ‚Äô,label:‚Äò‡∏Ñ‡∏≠‡πÄ‡∏•‡∏™‡πÄ‡∏ï‡∏≠‡∏£‡∏≠‡∏•‡∏™‡∏π‡∏á (‚â•200)‚Äô,n:annual.filter(r=>r.total_cholesterol>=200).length},
{icon:‚Äòüß°‚Äô,label:‚ÄòTG ‡∏™‡∏π‡∏á (‚â•150)‚Äô,n:annual.filter(r=>r.triglyceride>=150).length},
{icon:‚Äòü´Å‚Äô,label:‚Äò‡∏ï‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥ (AST/ALT>40)‚Äô,n:annual.filter(r=>(r.sgot>40||r.sgpt>40)).length},
{icon:‚Äòü´ò‚Äô,label:‚Äò‡πÑ‡∏ï‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥ (Cr>1.2)‚Äô,n:annual.filter(r=>r.creatinine>1.2).length},
{icon:‚Äò‚ù§Ô∏è‚Äô,label:‚ÄòEKG ‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥‚Äô,n:annual.filter(r=>r.ekg_result&&!r.ekg_result.includes(‚Äò‡∏õ‡∏Å‡∏ï‡∏¥‚Äô)&&r.ekg_result!==‚Äò‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏£‡∏ß‡∏à‚Äô).length},
];
const depts=[‚Äò‡πÅ‡∏ú‡∏ô‡∏Å‡∏Å‡πà‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á‚Äô,‚Äò‡πÅ‡∏ú‡∏ô‡∏Å‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‚Äô,‚Äò‡πÅ‡∏ú‡∏ô‡∏Å‡∏°‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå‚Äô,‚Äò‡πÅ‡∏ú‡∏ô‡∏Å‡∏Ñ‡∏•‡∏±‡∏á‡∏û‡∏±‡∏™‡∏î‡∏∏‚Äô,‚Äò‡πÅ‡∏ú‡∏ô‡∏Å‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‚Äô,‚Äò‡πÅ‡∏ú‡∏ô‡∏Å‡∏™‡∏ô‡∏±‡∏ö‡∏™‡∏ô‡∏∏‡∏ô‚Äô,‚Äò‡πÅ‡∏ú‡∏ô‡∏Å‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‚Äô];
const dpc=[100,95,100,88,100,92,100];
el.innerHTML=` <div class="grid-3" style="margin-bottom:18px;"> <div class="ov-card"><div class="ov-num" style="color:var(--pea-purple)">${total}</div><div class="ov-lbl">‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div></div> <div class="ov-card"><div class="ov-num" style="color:var(--info)">${n}</div><div class="ov-lbl">‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡∏±‡∏ö‡∏ï‡∏£‡∏ß‡∏à‡πÅ‡∏•‡πâ‡∏ß</div><div style="font-size:12px;color:var(--sub);margin-top:3px">${pct(n)}%</div></div> <div class="ov-card"><div class="ov-num" style="color:var(--warning)">${annual.filter(r=>r.bmi>=23||r.bp_systolic>=130||r.fbs>=100||r.total_cholesterol>=200).length}</div><div class="ov-lbl">‡∏û‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥ ‚â•1 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div></div> </div> <div class="grid-2"> <div class="card"><div class="card-title">‚ö†Ô∏è ‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏Ñ‡πà‡∏≤‡∏ú‡∏¥‡∏î‡πÄ‡∏Å‡∏ì‡∏ë‡πå (‡∏à‡∏≤‡∏Å ${n} ‡∏Ñ‡∏ô)</div> ${stats.map(s=>{const p=pct(s.n),c=p>=30?'#DC2626':p>=15?'#D97706':'#6B21A8';return`<div class="dept-row"><div style="font-size:12px;width:175px;flex-shrink:0">${s.icon} ${s.label}</div><div class="dept-track"><div class="dept-fill" style="width:${Math.min(p,100)}%;background:${c}"></div></div><div style="font-size:12px;font-weight:700;color:${c};width:45px;text-align:right">${s.n} ‡∏Ñ‡∏ô</div><div style="font-size:11px;color:var(--sub);width:32px;text-align:right">${p}%</div></div>`;}).join('')} </div> <div class="card"><div class="card-title">üè≠ ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏•‡∏∏‡∏° (‡∏£‡∏≤‡∏¢‡πÅ‡∏ú‡∏ô‡∏Å)</div> ${depts.map((d,i)=>`<div class="dept-row"><div class="dept-nm">${d}</div><div class="dept-track"><div class="dept-fill" style="width:${dpc[i]}%;background:${dpc[i]>=95?'var(--pea-purple)':'#D97706'}"></div></div><div class="dept-pct" style="color:${dpc[i]>=95?'var(--pea-purple)':'#92400E'}">${dpc[i]}%</div></div>`).join('')} </div> </div>`;
} catch(e) { el.innerHTML=`<div class="empty"><div class="empty-ico">‚ö†Ô∏è</div><h3>${e.message}</h3></div>`; }
}

// ===== OVERVIEW Risk Admin =====
async function loadOverview() {
if (currentUser.role !== ‚Äòadmin‚Äô) return;
const el = document.getElementById(‚Äòoverview-content‚Äô);
el.innerHTML = ‚Äò<div class="loading"><span class="spinner"></span>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‚Ä¶</div>‚Äô;
const { data: risk } = await sb.from(‚Äòrisk_checkup‚Äô).select(‚Äô*,employees(full_name,department)‚Äô).order(‚Äòcheckup_year‚Äô,{ascending:false}).limit(100);
const { data: emps } = await sb.from(‚Äòemployees‚Äô).select(‚Äòid‚Äô).eq(‚Äòrole‚Äô,‚Äòemployee‚Äô);
const total = emps?.length||142; const r = risk||[];
const depts=[‚Äò‡πÅ‡∏ú‡∏ô‡∏Å‡∏Å‡πà‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á‚Äô,‚Äò‡πÅ‡∏ú‡∏ô‡∏Å‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‚Äô,‚Äò‡πÅ‡∏ú‡∏ô‡∏Å‡∏°‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå‚Äô,‚Äò‡πÅ‡∏ú‡∏ô‡∏Å‡∏Ñ‡∏•‡∏±‡∏á‡∏û‡∏±‡∏™‡∏î‡∏∏‚Äô,‚Äò‡πÅ‡∏ú‡∏ô‡∏Å‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‚Äô,‚Äò‡πÅ‡∏ú‡∏ô‡∏Å‡∏™‡∏ô‡∏±‡∏ö‡∏™‡∏ô‡∏∏‡∏ô‚Äô,‚Äò‡πÅ‡∏ú‡∏ô‡∏Å‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‚Äô];
const dpc=[100,95,100,88,100,92,100];
el.innerHTML=`

  <div class="grid-3" style="margin-bottom:18px;">
    <div class="ov-card"><div class="ov-num" style="color:var(--pea-purple)">${total}</div><div class="ov-lbl">‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div></div>
    <div class="ov-card"><div class="ov-num" style="color:var(--info)">${r.length}</div><div class="ov-lbl">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏õ‡∏±‡∏à‡∏à‡∏±‡∏¢‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á</div></div>
    <div class="ov-card"><div class="ov-num" style="color:var(--danger)">${r.filter(x=>x.overall_result&&x.overall_result!=='‡∏õ‡∏Å‡∏ï‡∏¥').length}</div><div class="ov-lbl">‡∏û‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥</div></div>
  </div>
  <div class="grid-2">
    <div class="card"><div class="card-title">üè≠ ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏•‡∏∏‡∏°‡∏ï‡∏£‡∏ß‡∏à‡∏õ‡∏±‡∏à‡∏à‡∏±‡∏¢‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á (‡∏£‡∏≤‡∏¢‡πÅ‡∏ú‡∏ô‡∏Å)</div>
      ${depts.map((d,i)=>`<div class="dept-row"><div class="dept-nm">${d}</div><div class="dept-track"><div class="dept-fill" style="width:${dpc[i]}%;background:${dpc[i]>=95?'var(--pea-purple)':'#D97706'}"></div></div><div class="dept-pct" style="color:${dpc[i]>=95?'var(--pea-purple)':'#92400E'}">${dpc[i]}%</div></div>`).join('')}
    </div>
    <div class="card"><div class="card-title">‚ö†Ô∏è ‡∏ú‡∏•‡∏ï‡∏£‡∏ß‡∏à‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏£‡∏≤‡∏¢‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•</div>
      ${r.slice(0,8).map(x=>`<div class="risk-row"><div><div class="risk-nm">${x.employees?.full_name||x.emp_id}</div><div class="risk-sb">${x.employees?.department||''} ¬∑ ‡∏õ‡∏µ ${x.checkup_year}</div></div><span class="badge ${x.overall_result==='‡∏õ‡∏Å‡∏ï‡∏¥'?'b-ok':'b-warn'}">${x.overall_result||'‚Äî'}</span></div>`).join('')}
    </div>
  </div>`;
}

// ===== HELPERS =====
function dateTH(d) {
if (!d) return ‚Äò‚Äî‚Äô;
const months = [‚Äò‡∏°.‡∏Ñ.‚Äô,‚Äò‡∏Å.‡∏û.‚Äô,‚Äò‡∏°‡∏µ.‡∏Ñ.‚Äô,‚Äò‡πÄ‡∏°.‡∏¢.‚Äô,‚Äò‡∏û.‡∏Ñ.‚Äô,‚Äò‡∏°‡∏¥.‡∏¢.‚Äô,‚Äò‡∏Å.‡∏Ñ.‚Äô,‚Äò‡∏™.‡∏Ñ.‚Äô,‚Äò‡∏Å.‡∏¢.‚Äô,‚Äò‡∏ï.‡∏Ñ.‚Äô,‚Äò‡∏û.‡∏¢.‚Äô,‚Äò‡∏ò.‡∏Ñ.‚Äô];
const dt = new Date(d);
return `${dt.getDate()} ${months[dt.getMonth()]} ${dt.getFullYear()+543}`;
}
function showNotif(msg, type=‚Äòsuccess‚Äô) {
const el = document.getElementById(‚Äònotif‚Äô);
el.textContent = msg; el.className = `notif notif-${type}`;
el.style.display = ‚Äòblock‚Äô;
setTimeout(() => el.style.display=‚Äònone‚Äô, 3500);
}
</script>

</body>
</html>
